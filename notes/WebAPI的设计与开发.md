Web API 的设计与开发

# 什么是Web API 

分开看, 首先是API, 即应用程序接口, 通过以方法或其它形式暴露服务入口给用户, 用户通过访问该用户即可得到想要的服务, 而不必知道服务内部如何运作, 是一个封装的概念.

再来看Web API, 与常规的API其实差不多, 只不过它是以URI的形式暴露接口, 通过HTTP进行数据传输. 

## 什么是好的API

好的API应该有如下几个特征

- 易于使用
- 便于更改
- 健壮性好
- 不怕公之于众

# 端点的设计和请求的形式

## 端点的基本设计

- 短小便于输入
- 对用户友好易读
- 没有大小写混用, 建议全部使用消息, 多个单词时使用脊柱命名法. 
- 修改方便
- 不会暴露服务器架构
- 规则统一, 统一很重要

## Http方法和端点

- 以HTTP方法 + 资源的方式体现对一个资源的操作, 是最为科学的方式. 因此禁止编写通过GET方法修改服务器端信息的处理

- 常用的HTTP方法

  - PATCH, 跟新资源的部分信息
  - PUT, 更新资源的全部信息
  - HEAD, 获取资源的元数据

- 只能使用GET和POST的情况

  一些客户端比如一些HTTP库存在只能使用GET和POST的情况, 此时可以以POST请求, 然后在头部加入X-HTTP-Method-Override字段进行方法覆盖, 体现真正的METHOD,当然这需要支持

## 端点命名

- 使用名词复数形式
- 单词一定要和实际场景的语义相符
- 不能使用空格和需要编码的字符
- 多个单词时使用连接符链接
- 不确定如何命名时, 查看一下github, google等大厂的命名方式, 注意要多看一些, 因为只看一个有可能是错的.

### 使用记住命名法的理由

同域名, 域名中不允许出现下划线, 不区分大小写, 小数点有特殊含义, 因此这也是与域名规则保持一致

### 合适的域名

域名采用 api.xxx.com最好, 比如我们现在的api.haowande.com

## 适用于小范围的API设计

应尽量减少API访问次数, 因此接口聚合很重要.

## HATEOAS和REST LEVEL3 API

Martin Flowler认为, 在达到完美的REST API设计之前, 有一下集中API设计级别

- REST LEVEL 0: 使用HTTP
- REST LEVEL 1: 引入资源的概念
- REST LEVEL 2: 引入HTTP动词
- REST LEVEL 3: 引入HATEOAS概念

我们目前普遍处于LEVEL2阶段.  

HATEOAS, 即在响应的内容中包含接下来可能访问的URI, 用户不需要一开始就知道每一个URI, 只需要在访问一个URI后根据其返回的可用URI进行访问, 这样带来了很大的灵活性, URI的很多设计也就可以避免了, 而且维护难度也有所降低

但实现该级别的API在前端需要很大改动, 因此目前使用的并不多

# 响应数据的设计

## 格式

一般采用JSON格式响应, 但如果提供了多种响应格式可选, 可按照如下方式进行区分

- 参数添加 format=xml之类
- 请求头 Accept: application/json, 这是比较好的方式

## JSONP

jsonp就是在json数据的基础上附加了JavaScript的封装信息

## 数据内部结构

这里讲述的是以什么样的内部结构返回数据, 比如是否需要封装成对象, 需要暴露哪些字段等.

- 设计接口时要立足于应用程序的特性, 从更便于用户使用的角度来探讨API的设计方案.
- 为了完成一项任务需要多次访问API, 这样的API设计叫做Cahtty API , 这回增大流量消耗, 增加客户端处理工序, 给用户留下难用的印象.

### 让用户选择返回的内容

如果不确定需要返回哪些域, 可以让用户选择. 

- 添加fields查询参数, 指定返回的域
- 如果域过多, 可提供几个域集供用户选择

### 数据需要封装吗

封装的做法会显得冗长, 不值得实现. 更何况HTTP本身就是一种封装, 可以在其首部中存放很多信息, 因此应该充分利用HTTP提供的特性, 而不是自定义一些奇奇怪怪的封装.

例如可以返回合适的状态吗显示错误信息, 然后将更加详细的错误信息放入HTTP首部或响应消息体返回.

### 数据尽量扁平化吗?

是的, 数据应尽量扁平化, 除非层级有绝对优势. 或该场景非常适合使用层级的方式表示.

### 返回集合时应该封装吗

书中作者推荐封装, 但我自己是不推荐的.

## 具体数据的格式

### 数据名称

推荐采用驼峰命名法, 因为JSON是来自于JS, 而JS是推荐驼峰命名的

### 性别

生物学的性别时, 用sex; 其它意义上的性别, 应该用gender

### 日期格式

JSON字段中数据格式推荐采用 RFC3339, 即 2015-10-12T11:30:22+09:00

但注意, 在HTTP头部日期格式不一样, 应遵照HTTP协议操作

### 大数值

数值过大推荐采用字符串表示

## 错误信息的表示

出错时, 返回的错误信息一定要够详细, 不然人家都不知道为啥错了, 非常不友好

推荐的方式是HTTP状态吗表示大方向的错误, 再在HTTP头部或响应消息体中放入消息详细内容, 推荐后者. 比较好的错误信息应该包括 developerMessage, userMessage, errCode, info 等内容

# 最大程度地利用HTTP协议规范

## 正确使用状态码

### 2字头 处理成功

- 200 OK, 请求成功, 且没有进一步说明的必要
- 201 Created, 表示创建数据成功
- 202 Accepted, 表示服务器已接受请求, 但尚未处理完成, 用于异步耗时操作. 一般结合Retry-After首部使用
- 204 No Content, 常用于删除数据时返回204 

### 3字头 需要额外处理

- 301 表示资源被永久转移
- 302 表示资源被临时转义
- 303 引用他处, 无论在重定向之前使用什么方法访问, 都允许在请求完成后用GET方法继续访问
- 307, 308, 在访问过程中不允许任何HTTP方法发生变更
- 304 表示用户上次获取的数据至今为止没有发生更新

### 4字头

- 401 我不知道你是谁
- 403 我知道你是谁, 但你没有权限访问这个东西
- 406 API不支持客户端指定的数据格式
- 409 资源发生冲突
- 410 Gone, 表示该资源本来存在, 但现在不存在了
- 429 Too Many Request, 太多请求, 常用于限速

### 5字头

- 500 服务器内部错误
- 503 服务器暂时不可用,

## HTTP缓存

- 过期模型

  指定缓存的时长, 时长之内将不会请求服务, 时长之后将会请求服务

  实现 有两个方式

  - 头部加Expires字段, 指明过期的绝对时间
  - 头部加Cache-Control字段, 指明过期的相对时间

  涉及到时间, 由于必须参照服务器的时间, 因此HTTP 1.1 规定, 除了5字头响应外, 所有的HTTP消息都要加上Date字段. 这样就算本地时间出错也不怕

- 验证模型

  每次还是请求, 只不过会将上次修改时间和上次数据的ETag发送到服务器, 服务器检测到有修改时就返回, 没有修改时就不返回数据.

- 禁用缓存

  Cache-Control: no-cache

  至少使用验证模型来缓存, 而不是不要缓存

  Cache-Control: no-store

  不需要缓存

- 使用Vary指定缓存单位

  指定除URI外使用哪个请求首部确定唯一数据

## 媒体类型的指定

- x-开头的类型

  表示该类型尚未在IANA注册

- 自定义媒体类型

  根据不同前缀区分如下

  - Standards tree, 标准树, 没有前缀
  - Vendor tree, 供应商树, 表示很多人使用, 但是有其它单位维护的, 以vnd开头, 如微软的excel, vnd.ms-excel
  - Personal tree, 个人树, 实验性质的, prs开头
  - Unregistered tree, 未注册树, 但使用得非常少.

## CORS

跨域资源共享基本步骤

- 发送origin询问是否可访问
- 服务端响应Access-Control-Allow-Origin: ... 说明允许访问的域名
- 客户端发送正式消息

# 开发更方便的Web API设计

版本管理的方案:

- URI中嵌入版本号, 这是目前使用最多的方式
- 查询参数中嵌入版本号, 如果不给该参数则默认为最新或最旧版本, 这种方式不好
- 在首部中放入版本号, 但这个实属罕见, 这是我自己加的.

# 开发安全的Web API 

为了安全, 一定要用HTTPS加密

如下几种常见的网络攻击例子

- XSS



- XSRF



- JSON劫持



## 设计时需时时刻刻考虑安全问题

- 参数被篡改

  对参数的验证要做到万无一失

- 请求多次发送

  需要过滤两次发送同一请求的情况

## 应对大规模访问的策略

- 限制每个用户的访问频率. 对每个用户进行计数的工作, 可以交给Redis或MEMCACHED这种存储中间件来做.

# 一些点

- 可供参考的API设计

  ProgrammableWeb**网站, 想要设计出优美的API, 就必须调查比较目前已有的各种API设计. 

- 关于文档

  从API用户的角度而言, 如果开发过程中还需要不断地去翻阅文档, 那么这样的API显然增加了开发人员的负担

- 关于接口

  服务器端的处理应该全部在服务器内部完成, 而不应该让用户费心

- 统一的重要性

  不管是接口命名, 还是其它的规定, 一定要做到统一

