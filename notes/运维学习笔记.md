# 《蜕变：从菜鸟到Linux安全专家》

> 按优先级，依次查看如下章节
>
> - 第十一章
> - 第十二章
> - 第九章

## 防火墙

其实，iptables与firewalld都不是真正的防火墙，它们都只是用来定义防火墙策略的防火墙管理工具而已，或者说，它们只是一种服务。iptables服务会把配置好的防火墙策略交由内核层面的netfilter网络过滤器来处理，而firewalld服务则是把配置好的防火墙策略交由内核层面的nftables包过滤框架来处理。

在早期的Linux系统中，默认使用的是iptables防火墙管理服务来配置防火墙。尽管新型的firewalld防火墙管理服务已经被投入使用多年，但是大量的企业在生产环境中依然出于各种原因而继续使用iptables。

### iptables

- iptables命令可以根据流量的源地址、目的地址、传输协议、服务类型等信息进行匹配，一旦匹配成功，iptables就会根据策略规则所预设的动作来处理这些流量。
- 防火墙策略规则的匹配顺序是从上至下的，因此要把较为严格、优先级较高的策略规则放到前面，以免发生错误。

具体操作：https://www.linuxprobe.com/chapter-08.html



### firewalld

- 还差网络基础知识，先补全基础再来看。https://www.linuxprobe.com/chapter-08.html



# 《计算机网络》

> 按优先级，依次学习如下章节
>
> - 第一章
>   - 1.6
>   - 1.7
> - 第二章
>   - 2.6
> - 第三章
>   - 整章
> - 后面的每一章

## 第一章节

计算机网络几个指标

- 速率
- 带宽：速率的最大值
- 吞吐量：感觉和带宽差不多的概念

这三个概念差不多

## 第二章节 - 物理层

### OSI和TCP/IP啥关系

OSI全称OSI/RM(Open System Interconnection Reference Model，开放系统互联协议)，1983年提出，试图让全世界的网络标准都遵循这个统一的标准。但是几乎没有什么计算机产品遵循这个标准，原因是

- 专家缺乏实际经验
- 实现过于复杂，运行效率低
- 标准指定周期长
- 层次划分不合理，部分功能在多个层中多次出现

TPC/IP是一个参考OSI并进行简化的模型，是事实上的标准。与OSI这个法律上的标准形成了鲜明的对比。

### 要学习的模型

OSI是7层，事实上的标准TCP/IP是四层，而为了更好地学习计算机网络的各层，选择综合OSI和TCP/IP的优点，拿出一个5层协议的体系结构进行学习。

注意并不是真的由这样一个体系结构，这只是为了方便我们学习的模型。

![image-20201129154956764](https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129154956764.png)

### 宽带接入

- 如果用户要连接到公网，必须先连接到某个ISP，以便获得上网所需的IP地址。

### ADSL

非对称数字用户线ADSL（Asymmetric Digital Subscriber Line）技术是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带数字业务。虽然标准模拟电话信号的频带被限制在300～3 400Hz的范围内（这是电话局的交换机设置的标准话路频带），但用户线本身实际可通过的信号频率却超过1MHz。ADSL技术把0～4kHz低端频谱留给传统电话使用，而把原来没有被利用的高端频谱留给用户上网使用。ADSL的ITU的标准是G.992.1 （或称G.dmt，表示它使用DMT技术，见后面的介绍）。由于用户在上网时主要是从因特网下载各种文档，而向因特网发送的信息量一般都不太大，因此ADSL的下行（从ISP到用户）带宽都远远大于上行（从用户到ISP）带宽。“非对称”这个名词就是这样得出的。

ADSL在用户线（铜线）的两端各安装一个ADSL调制解调器。

ADSL最大的好处就是可以利用现有电话网中的用户线，不需要重新布线。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129161130207.png" alt="image-20201129161130207" style="zoom:70%;" />

实际家中使用时，看起来只是接了一个ADSL调制解调器就能够使用电话线来上网了，实际上在电话线另外一头还有一个电话局的调制解调器用于解析获取用户的上网信息。而电话线中电话部分的信号则被低通滤波器过滤，依旧传输到原电话服务。

也就是说，ADSL只是利用了电话线进行传输而已，省去了布线的成本。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129161547234.png" alt="image-20201129161547234" style="zoom:67%;" />

### 光纤同轴混合网（HFC网）

### FTTx技术

## 第三章节 - 数据链路层

### 链路和数据链路的区别

所谓**链路(link)**就是从一个结点到相邻结点的一段物理线路（有线或无线），而中间没有任何其他的交换结点。在进行数据通信时，两个计算机之间的通信路径往往要经过许多段这样的链路。可见链路只是一条路径的组成部分。

**数据链路(data link)**则是另一个概念。这是因为当需要在一条线路上传送数据时，除了必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输（这将在后面几节讨论）。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。现在最常用的方法是使用网络适配器（既有硬件，也包括软件）来实现这些协议。一般的适配器都包括了数据链路层和物理层这两层的功能。

我的理解：数据链路包括硬件和软件，而这个级别的软件是类似I2C、串口之类的硬件层协议，是规定数据如何在物理链路中传播的协议。而数据链路层的协议数据单元——帧也从侧面证实了这一点。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129170134467.png" alt="image-20201129170134467" style="zoom:67%;" />

### 数据链路层要解决的三个基本问题

- 封装成帧

  数据加上头尾就成了一个完整可传输的帧。

- 透明传输

  帧必须是可透明传输的，即不管数据中包含何种字符，都应该能够成功。对于特殊字符，在前面加上转义符即可。

- 错误侦测

  主要是检测数据传输是否有误，可以使用CRC校验之类的算法校验。对于校验失败的可以进行重传。

### 点对点传输 - PPP协议

因特网用户通常都要连接到某个ISP才能接入到因特网。PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议。

#### 特点

- 简单

  IETF在因特网设计时将最复杂的部分放在了TCP协议中，网际协议IP则相对比较简单，更下层的数据链路层协议没有必要更复杂。PPP协议简单到什么程度呢？——接收方每收到一个帧，就进行CRC检验。如CRC检验正确，就收下这个帧；反之，就丢弃这个帧，其他什么也不做。

- 满足上面说的三个基本问题

- 支持多种网络层协议

  这是通过在帧中添加协议类型位做到的。

- 支持多种类型的链路

  除了要支持多种网络层的协议外，PPP还必须能够在多种类型的链路上运行。例如，串行的（一次只发送一个比特）或并行的（一次并行地发送多个比特），同步的或异步的，低速的或高速的，电的或光的，交换的（动态的）或非交换的（静态的）点对点链路

  PPOE就是一个典型的例子（详情见后面分析）

- 检测连接状态

  可自动检测出链路是否处于正常工作状态

**在TCP/IP协议族中，可靠传输由运输层的TCP协议负责，因此数据链路层的PPP协议不需要进行纠错**，不需要设置序号，也不需要进行流量控制。PPP协议不支持多点线路（即一个主站轮流和链路上的多个从站进行通信），而只支持点对点的链路通信。此外， PPP协议只支持全双工链路。

#### 组成

- 将IP数据报封装到串行链路的方法。PPP既支持异步链路（无奇偶检验的8比特数据），也支持面向比特的同步链路。
- 一个链路控制协议LCP：用于建立、配置和测试数据链路连接
- 一套网络控制协议NCP：每一个协议支持不同的网络层协议，如IP、OSI的网络层、DECnet，以及AppleTalk

#### 帧格式

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129203118779.png" alt="image-20201129203118779" style="zoom:67%;" />

注意其中的协议部分

- 0x0021时，表示该帧传输的是IP数据报
- 0xC021时，表示该帧传输的是LCP数据
- 0x8021时，表示该帧传输的是网络层的控制数据

#### 工作状态

PPP的工作过程

- 用户拨号连接ISP，建立了一条从用户PC到ISP的物理连接（通常是点击连接按钮）

- LCP协商：PC向ISP发送LCP分组（被封装成多个PPP帧），用于协商PPP参数，参数包括

  - 最大帧长度
  - 要使用的鉴别协议

- 鉴别（如果需要），支持两种鉴别方式

  - PAP（Password Authentication Protocol）：发起通信的一方给出身份标识和口令
  - CHAP（Chanllenge-HandShake Authentication Protocol）：

- NCP协商：PC向ISP发送NCP分组，协商网络协议，明白对方使用何种网络协议。这样，即使两端使用不同的网络协议，依然能够通过PPP传递消息

  如果是IP协议，则对PPP链路的每一端配置IP协议模块（如分配IP地址）时就要使用NCP中支持IP的协议——IP控制协议IPCP (IP Control Protocol)。

- LCP终止，一方发出终止请求，另一方响应。到达终止状态。

用图片表示如下。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129203833379.png" alt="image-20201129203833379" style="zoom:67%;" />

#### 所以？

PPP中，最先要建立物理连接，然后LCP协议协商链路控制，再NCP协商网络协议，因此PPP已经不纯粹是数据链路层的协议了，还包括了物理层和网络层的东西。

### 广播信道传输 - CSMA-CD协议

#### 局域网简介

局域网最主要的特点是：网络为一个单位所拥有，且地理范围和站点数目均有限。

局域网内各主机共享信道，使用了随机接入的方法：用户随机的发送消息，但如果恰巧有两个或更多的用户在同一时刻发送信息，那么在共享媒体上就要产生碰撞（即发生了冲突），使得这些用户的发送都失败。因此，必须有解决碰撞的网络协议

#### 什么是以太网

以太网是1975年研制成功的一种局域网，用无缘电缆作为总线，并用曾经标识电磁波的以太命名，得名以太网。Ethernet。

后来，提出了DIX Ethernet V2和802.3两个局域网标准，都称为以太网。

再后来，TCP/IP体系经常使用的局域网只剩下DIX Ethernet V2而不是IEEE 802.3标准中的局域网。因此以太网专门指DIX Ethernet V2标准的局域网。

以太网有两个特点

- 采用灵活的无连接的工作方式，不建立连接即可发送数据，数据的完整性由上层协议入TCP来保证。
- 数据发送采用曼彻斯特编码

#### LLC和MAC层

为了使数据链路层能更好地适应多种局域网标准，IEEE 802委员会就把局域网的数据链路层拆成两个子层，即逻辑链路控制 LLC (Logical Link Control)子层和媒体接入控制MAC (Medium Access Control)子层。与接入到传输媒体有关的内容都放在MAC子层，而LLC子层则与传输媒体无关。

LLC是802.3标准的内容，随着它的消失，LLC层也消失了。只剩下MAC层。

#### 网卡的作用

计算机与外界局域网连接是通过通信适配器，它就是网卡。

网卡上包含处理器和存储器，网卡通过有线或无线同局域网相连，通过计算机主板的IO总线与CPU相连。它的作用如下

- 将CPU传输的数据转换为穿行数据输出给局域网。而CPU速率和网络速率不一致，因此需要网卡上有缓存将数据存起来
- 适配器接收和发送各种帧时不使用计算机的CPU。这时CPU可以处理其他任务。当适配器收到有差错的帧时，就把这个帧丢弃而不必通知计算机。当适配器收到正确的帧时，它就使用中断来通知该计算机并交付协议栈中的网络层。当计算机要发送IP数据报时，就由协议栈把IP数据报向下交给适配器，组装成帧后发送到局域网。

注意点

- 计算机在网络中的硬件地址，其实就是网卡地址，存储在网卡的ROM中的
- 计算机的IP地址，则是存储在计算机自己的存储器中的

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129212311198.png" alt="image-20201129212311198" style="zoom:67%;" />

#### CSMA/CD

CSMA/CD，意思是载波监听多点接入/碰撞检测(Carrier Sense Multiple Access with Collision Detection)

上面有说，局域网各主机共享信道，采用随机接入的方法，主机随机发言，如果有两个主机同时发言，就产生了碰撞，CSMA/CD解决了这个问题。

要点

- 多点接入：就是说明这是总线型网络，许多计算机以多点接入的方式连接在一根总线上

- 载波监听”就是用电子技术检测总线上有没有其他计算机也在发送。其实总线上并没有什么“载波”，这里只不过借用一下“载波”这个名词而已。因此载波监听就是检测信道，这是个很重要的措施。

  不管在发送前，还是在发送中，每个站都必须不停地检测信道。在发送前检测信道，是为了获得发送权。如果检测出已经有其他站在发送，则自己就暂时不许发送数据，必须要等到信道变为空闲时才能发送。在发送中检测信道，是为了及时发现有没有其他站的发送和本站发送的碰撞。这就称为碰撞检测。

  碰撞检测”也就是“边发送边监听”，即适配器边发送数据边检测信道上的信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。

- 这就意味着，以太网在发送过程中要不停地检测信道

**感觉这样数据交换效率很低呀，怎么解决的呢**。

### 广播信道传输 - 以太网

CSMA/CD是工作在总线型的局域网的协议，而总线局域网已被淘汰。

#### 新的局域网

新的局域网采用星形连接，核心部件是集线器。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129220342053.png" alt="image-20201129220342053" style="zoom:67%;" />

特点

- 使用集线器的以太网在逻辑上仍是一个总线网，各主机共享逻辑上的总线，使用的还是CSMA/CD协议

  集线器只是用电子器件模拟实际电缆的工作

- 1个集线器有许多接口[插图]，例如，8至16个，每个接口通过RJ-45插头

- **集线器工作在物理层，它的每个接口仅仅简单地转发比特**——收到1就转发1，收到0就转发0，不进行碰撞检测。

- 集线器采用了专门的芯片，进行自适应串音回波抵消。这样就可使接口转发出去的较强信号不致对该接口接收到的较弱信号产生干扰

#### 以太网的信道利用率

以太网的利用率由于碰撞的存在，会导致信道利用率达不到100%

#### 以太网的MAC层

在局域网中，硬件地址又称为物理地址或 MAC地址（因为这种地址用在MAC帧中）。MAC地址存储在网卡的ROM中。

**MAC地址的划分**

- IEEE的注册管理机构RA (Registration Authority)是局域网全球地址的法定管理机构[W-IEEERA]，它负责分配地址字段的6个字节中的前三个字节(即高位24位)。

  世界上凡要生产局域网适配器的厂家都必须向IEEE购买由这三个字节构成的这个号（即地址块），这个号的正式名称是组织唯一标识符OUI (Organizationally Unique Identifier)，通常也叫做公司标识符(company_id)。

  但应注意，24位的OUI不能够单独使用来标志一个公司，因为一个公司可能有几个OUI，也可能有几个小公司合起来购买一个OUI。

- IEEE规定地址字段的第一字节的最低位为I/G位。I/G表示Individual/Group。当I/G位为0时，地址字段表示一个单个站地址。当I/G位为1时表示组地址，用来进行多播（以前曾译为组播）。因此，IEEE只分配地址字段前三个字节中的23位。当I/G位分别为0和1时，一个地址块可分别生成224个单个站地址和224个组地址。

**MAC帧**

这里只介绍DIX Ethernet V2标准的帧

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129221832835.png" alt="image-20201129220342053" style="zoom:67%;" />

- 其中的类型表示网络层的协议类型，决定了数据被提交给何种协议处理
  - 0x0800：IP数据包
  - 0x8137：Novell IPX数据包

#### 在数据链路层扩展以太网

**网桥**

在数据链路层扩展以太网要使用网桥(bridge)。**网桥工作在数据链路层，它根据MAC帧的目的地址对收到的帧进行转发和过滤**。

网桥依靠转发表来转发帧。转发表也叫做转发数据库或路由目录。转发表记录了以太网中主机和网桥接口的对应关系。

而转发表是可以自学习的来的，这很容易，因为发送到网桥上的帧由来源主机和对应的接口。

**源路由网桥**

网桥每次都是被动的选择帧传输路径，会造成资源使用不充分。

为此产生了源路由网桥，它先来一个发现帧，传输到目标主机再返回，记录沿途所有路由，下次发送时直接按照这个路由走就行了。

**以太网交换机**

以太网交换机实质上就是一个多接口的网桥。和工作在物理层的转发器、集线器有很大的差别。

因为二层交换机记录了接口和MAC地址的关系，由路由功能。而集线器只是对数据位的单纯转发，不管其逻辑意义。

**交换机实现VLAN**

VLAN是在802.1Q标准中提出的。

虚拟局域网VLAN是由一些局域网网段构成的与物理位置无关的逻辑组，而这些网段具有某些共同的需求。

其实现方式是在MAC帧中插入VLAN ID

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129223955614.png" alt="image-20201129223955614" style="zoom:67%;" />

记住，VLAN是通过二层交换机实现的。

### 高速以太网

速率达到或超过100Mb/s的以太网称为高速以太网

#### 100BASE-T以太网

100BASE-T是在双绞线上传送100Mb/s基带信号的星型拓扑以太网，仍使用IEEE 802.3的CSMA/CD协议，它又称为快速以太网(Fast Ethernet)。用户只要更换一个适配器，再配上一个100Mb/s的集线器，就可很方便地由10BASE-T以太网直接升级到100Mb/s，而不必改变网络的拓扑结构。

#### 吉比特以太网

目前市场上出售的各种计算机的以太网接口，已基本上都是1Gb/s的

吉比特以太网的标准IEEE 802.3z有以下几个特点：

(1) 允许在1Gb/s下全双工和半双工两种方式工作。

(2) 使用IEEE 802.3协议规定的帧格式。

(3) 在半双工方式下使用CSMA/CD协议（全双工方式不需要使用CSMA/CD协议）。

(4) 与10BASE-T和100BASE-T技术向后兼容。

#### 10吉比特和100吉比特以太网

### 使用以太网进行宽带接入

以太网接入的一个重要特点是它可以提供双向的宽带通信，并且可以根据用户对带宽的需求灵活地进行带宽升级（例如，把10兆的以太网交换机更新为100兆甚至吉比特的以太网交换机）。

然而以太网的帧格式标准中，在地址字段部分并没有用户名字段，也没有让用户键入密码来鉴别用户身份的过程。如果网络运营商要利用以太网接入到因特网，就必须解决这个问题。

于是有人就想法子把数据链路层的两个成功的协议结合起来，即把PPP协议中的PPP帧再封装到以太网中来传输。这就是1999年公布的PPPoE (PPP over Ethernet)，意思是“在以太网上运行PPP”





### 网卡的过滤功能

MAC帧的类型

(1) 单播(unicast)帧（一对一），即收到的帧的MAC地址与本站的硬件地址相同。

(2) 广播(broadcast)帧（一对全体），即发送给本局域网上所有站点的帧（全1地址）。

(3) 多播(multicast)帧（一对多），即发送给本局域网上一部分站点的帧。

以太网适配器还可设置为一种特殊的工作方式，即混杂方式(promiscuous mode)。工作在混杂方式的适配器只要“听到”有帧在以太网上传输就都悄悄地接收下来，而不管这些帧是发往哪个站。

但混杂方式有时却非常有用。例如，网络维护和管理人员需要用这种方式来监视和分析以太网上的流量，以便找出提高网络性能的具体措施。有一种很有用的网络工具叫做嗅探器(Sniffer)就使用了设置为混杂方式的网络适配器。此外，这种嗅探器还可帮助学习网络的人员更好地理解各种网络协议的工作原理。因此，混杂方式就像一把双刃剑，是利是弊要看你怎样使用它。

- 以太网、快速以太网，它们到底是啥？

## 第四章节 - 网络层

### 网络层的设计思路

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。网络在发送分组时不需要先建立连接。每一个分组（也就是IP数据报）独立发送，与其前后的分组无关（不进行编号）。网络层不提供服务质量的承诺。**这样能够使网络层的路由器做得比较简单，并且价格相对低廉**。

如果通信需要是可靠的，那么则由运输层去控制：包括差错处理、流量控制。

如果在网络层去做可靠传输，就是将复杂度转移到了网络层，白白浪费了计算机的强大处理能力。

### 几个协议

- IP：是重要的英特网标准协议之一
- ARP： 地址解析协议
- ICMP：网络控制报文协议
- IGMP：网际组管理协议

它们在网络层中的关系如下图所示。

![image-20210110154935578](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110154935578.png)

网际层：由于网际协议IP是用来使互连起来的许多计算机网络能够进行通信，因此TCP/IP体系中的网络层常常称为网际层(internetlayer)，或IP层。

#### ARP

地址解析协议的作用：根据一个机器的IP地址找出相应的硬件地址，以将网络层报文在数据链路层进行传输。

协议原理：

- 原理：在主机ARP高速缓存中应存放一个从IP地址到硬件地址的映射表，并且这个映射表还经常动态更新（新增或超时删除）。
- 映射关系添加方式：主机B刚加入时没有映射关系怎么办，此时主机A在局域网广播ARP请求，告诉所有其它主机自己的IP和硬件地址，并查找期望的IP对应的硬件地址，此时主机B记录下主机A的映射关系，并回复自己的映射关系。然后映射建立成功。
- 注意多个局域网互联成一个局域网的情况，此时存储的ARP映射并非直接，而是会经过路由器转发的。

PS：**ARP到底算网络层还是数据链路层？由于其是使用IP地址查找硬件地址，因此可以算作网络层；但又因为找出的硬件地址在数据链路层使用，因此也可以算作数据链路层。两种分法都算OK的。**

**疑问：既然最终都要使用物理地址传输，为何不一开始就用物理地址传输呢？**

由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此由用户或用户主机来完成这项工作几乎是不可能的事。但统一的IP地址把这个复杂问题解决了。

####　ICMP

使用ICMP是为了有效地转发数据报和提高交付成功的机会：ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告

听起来可能有点奇怪，但看了ICMP的报文类型你一下子就能明白了。

![image-20210110183246277](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110183246277.png)

##### 差错报告报文

- 终点不可达：当路由器或主机不能交付数据报时就向源点发送终点不可达报文
- 源点抑制：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。
- 时间超过：当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。
- 参数问题：当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
- 改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

##### 询问报文

- 回送请求和回答：用于测试目的站是否可达，以了解其有关状态。
- 时间戳请求和回答：用于进行时间同步和测量时间。ICMP时间戳请求报文是请某个主机或路由器回答当前的日期和时间。

##### 应用举例

- **ping**：使用了询问报文回送请求和回答

- **traceroute**：它用来跟踪一个分组从源点到终点的路径

  原理：向目的主机发送一连串IP数据报文，第一个报文设置TTL为1，当到达第一个路由器R1时，TTL被减1，变成0，R1就将报文丢弃，并向源主机发送差错报告报文“时间超过”；以此类推，就能跟踪出整个路径。

##### 为什么我的traceroute路径上出现星号

因为ICMP报文类型是可以被封的，如果被封了，就看不到了。

### 几个中间设备

- 转发器：物理层使用的中间设备
- 网桥：数据链路层使用的中间设备
- 路由器：网络层使用的中间设备：路由器其实就是一台专用计算机，用来在互联网中进行路由选择。
- 网关：网络层以上使用的中间设备。用网关连接两个不兼容的系统需要在高层进行协议的转换。

### IP的编址方法

IP地址的编址方法总共经过三个历史阶段

- 分类的IP地址：基本的编址方法，1981年通过
- 子网的划分：对基本编址方法的改进，1985年通过
- 构成超网：新的无分类编址方法，1993年提出后很快得到推广和应用

#### 分类的IP地址

首先说明，分类的IP地址已经成为历史，学习它有助于了解编址方法的演进。

如下图所示，被分为A-E几类地址，ABC为单播地址；D为多播地址；E保留为今后使用。

单播地址中，又分为网络号和主机号，这样区分的考虑：各种网络的差异很大，有的网络拥有很多主机，而有的网络上的主机则很少。把IP地址划分为A类、B类和C类是为了更好地满足不同用户的要求。当某个单位申请到一个IP地址时，实际上是获得了具有同样网络号的一块地址。其中具体的各个主机号则由该单位自行分配，只要做到在该单位管辖的范围内无重复的主机号即可。

![image-20210110160807635](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110160807635.png)

##### A类地址

- 网络号全0：IP地址中的全0表示this，因此网络号全0表示本网络
- 网络号127：网络号为127被保留作为本地软件的回环测试。当向127开头的IP地址请求时，软件协议会直接处理该请求，而不会发送到任何网络上。因此网络上不可能出现它

- 主机号全0：表示本主机所连接到的单个网络地址
- 主机号全1：表示当前网络上的所有主机

A类地址占所有IP的一半

##### B类地址

整个B类地址空间共约有230个地址，占整个IP地址空间的25%

- 网络号全0、主机号全0、全1也适用于B类地址

##### C类地址

整个C类地址空间共约有229个地址，占整个IP地址的12.5%。

- 网络号全0,、主机全0、全1也适用于C类地址

上述哪些特殊的IP总结如下

![image-20210110162547962](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110162547962.png)

##### 各类的私有地址

在IP地址3种主要类型里，又各保留了3个区域作为私有地址，也就是比较常用的ip地址。其地址范围如下：
A类地址：10.0.0.0～10.255.255.255
B类地址：172.16.0.0～172.31.255.255
C类地址：192.168.0.0～192.168.255.255

#### 子网的划分

##### 为什么要划分子网

使用分类的IP地址有几个缺点

- IP地址空间利用率低，一个A类地址可容纳主机数超千万，但实际网络因为各种原因远远达不到这个数量，导致利用率低。导致IP地址浪费
- 网络号+主机号的方式不够灵活，要开通新的网络，只能获取一个新的网络号，过程缓慢

##### 子网划分的方式

子网划分就是将两级网络变成三级网络。使得网络号+主机号的方式变成主机号+子网号+主机号的方式。原来的子网号被再次划分了。

为了能够快速得出被划分后的子网号，使用子网掩码。将IP地址与子网掩码做与运算，即可马上得出该IP地址对应的子网号。

![image-20210110174441628](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110174441628.png)

##### 默认子网掩码

在不划分子网时，依旧需要子网掩码，因为子网掩码在现在的网络要求中已经是必须的了，它是一个网络或一个子网的重要属性。

例如，A类地址的子网掩码是255.0.0.0

新标准的路由表包含几个内容：目的网络地址、子网掩码、下一跳地址。与之前相比，多了子网掩码，每次进行网络地址匹配前，都需要使用子网掩码计算真实的子网地址。在不划分子网时依旧强制要求使用子网掩码，也是为了路由器能够使用一致的算法进行路由计算。

##### 子网掩码的缺点

将原本的主机地址部分用于做子网，好处是增加灵活性，坏处就是减少了一个网络地址容纳的主机数量，且子网划分得越多，挤占主机地址越多，能够容纳的主机越少。

#### 无分类域间路由选择，CIDR（构成超网）

##### 为什么要CIDR

- B类地址即将用完
- 因特网主干网上的路由表项目数急剧增长

使用CIDR的一个好处就是可以更加有效地分配IPv4的地址空间，可根据客户的需要分配适当大小的CIDR地址块。

##### 什么是CIDR

- 消除传统的A、B、C类地址和子网划分的概念。只使用网络前缀和主机号。即又从三级变回了两级，只不过没了IP分类。

  记录方法：128.14.35.7/20，表示前20个bit是网络前缀。

- CIDR把网络前缀都相同的连续的IP地址组成一个“CIDR地址块”

##### 地址聚合

地址聚合是相对的，指的是原本需要由多个分类地址表示的网络块，现在只需要一个前缀表示即可。例如，为某单位分配四个C类网络地址，则在路由表中至少需要四条记录（因为分类地址决定了最小分配单位必须为某一类地址），但如果使用前缀，则只需要一条（因为已经没有分类的概念的）

**CIDR的使用已经推迟了IP地址将要耗尽的日期。**

### IP地址与硬件地址

**一定要搞清楚IP地址与硬件地址的区别：一定！！！**

IP地址：网络层使用的IP地址，是逻辑地址，是会发生变化的。

硬件地址：数据链路层和物理层使用的地址，是真实的地址（一块网卡对应的地址，是永远不会变的）。

二者的关系：使用IP地址的IP数据报一旦交给了数据链路层，就被封装成MAC帧了。MAC帧的源地址和目标地址都是硬件地址。MAC帧被传输到目标端时，从MAC帧中解析出IP报文，才能看到源IP地址和目标IP地址

总之，IP 地址放在 IP 数据报的首部，而硬件地址则放在 MAC 帧的首部。在网络层和网络层以上使用的是 IP 地址，而数据链路层及以下使用的是硬件地址。数据链路层看不见数据报的IP地址。如下图

![image-20210110163837903](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110163837903.png)

下图非常形象地展示了IP地址和MAC地址在报文传输时各自扮演的角色

![image-20210110164007703](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110164007703.png)

**强调一点：路由器只根据目的站的IP地址的网络号进行路由选择。**

### 网络层转发分组的流程

#### 路由器转发分组的流程

路由器存储有路由表，即目标主机所在网络和下一跳地址。如

![image-20210110170201182](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110170201182.png)

总结如下

- 从数据报的首部提取目的主机的IP地址D, 得出目的网络地址为N。
- 若N就是与此路由器直接相连的某个网络地址，则进行直接交付；否则执行下一步。
- 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行下一步。
- 若路由表中有到达网络N的路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行下一步。
- 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行下一步
- 报告分组转发错误

#### IP数据报中没有下一跳路由器的IP地址，那么待转发的数据报又怎样能够找到下一跳路由器呢？

答案是ARP，路由器收到报文后，根据路由表得出下一跳IP地址，再由ARP将其转换为下一跳路由器的MAC地址，从而转发过去。前面有说过，ARP存储了IP和MAC地址的对应关系。

#### 路由器的路由表建立过程？



### 路由选择协议

#### 几个概念

- 静态路由选择策略：即手动添加路由表项目，适合小型系统。

- 动态路由选择策略：即根据算法动态调整路由表项目，计算复杂，但适用于随时处于变化中的互联网。

- 分层次的路由选择协议：由于因特网规模非常大，且许多单位不愿意让外界看到自己的网络布局，因此将整个互联网划分为许多小的自治系统，简称AS。每个AS对外部表现的是一个单一的和一致的路由选择策略。

  如一个ISP就可以算作是一个AS。

- IGP：内部网关协议，即在AS内部使用的协议，如RIP和OSPF

- EGP：外部网关协议，AS之间的协议，需要将一个AS使用的路由协议转换为另一个系统使用的路由协议。如BGP-4

- 域间路由选择：即AS之间的路由选择
- 域内路由选择：即AS内部的路由选择

注意：上面说的网关并非严格意义上的网关，这里指的是网络层的的转换，路由器的概念。

#### RIP

即Route Infomation Protocol，它是分布式的基于距离向量的路由选择协议。

距离：即到达目标主机经过的路由次数，每路由一次都增加1。1又称为跳数。RIP允许一条路径的最大跳数为15，因此仅适合小型网络。

特点

- 仅和相邻路由器交换信息
- 路由器交换的信息是当前本路由器所知道的全部信息，即自己的路由表
- 按固定的时间间隔交换路由信息，例如，每隔30秒。然后路由器根据收到的路由信息更新路由表

路由器刚开始工作时，只知道它的相邻路由器，按照相邻交换的方式，最终会进行收敛，得到正确的路由表信息。

优点

- 实现简单，开销小

缺点

- 最长路径跳数规定为15，限制了网络的大小
- 路由器之间交换的是完整路由表，网络扩大后消耗会增加
- “坏消息传播得慢”，使更新过程的收敛时间过长。

#### OSPF

Open Shortest Path First，开放最短路径优先

与RIP相比的特点

- 向本自治系统中所有路由器发送信息。这就是路由器通过所有输出端口向所有相邻的路由器发送信息。而每一个相邻路由器又再将此信息发往其所有的相邻路由器（但不再发送给刚刚发来信息的那个路由器）

  RIP仅向相邻路由器发送数据。

- 发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。所谓 “链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)。OSPF将这个“度量”用来表示费用、距离、时延、带宽，等等。

  RIP发送的到所有路由器的距离。

- 只有当链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息。

  RIP还会定时交换信息。

原理就是这样，但实现起来较为复杂，有兴趣自己去研究。

#### BGP

边界网关协议BGP只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。BGP采用了路径向量(path vector)路由选择协议，它与距离向量协议（如RIP）和链路状态协议（如OSPF）都有很大的区别。

- 核心：BGP发言人，每个AS都要有一个BGP发言人，两个BGP发言人都是通过一个共享网络连接在一起的，而BGP发言人往往就是BGP边界路由器
- BGP发言人交换的路由信息只是：”如果你要访问网络x1、x2...可以经过ASx“，因此它交换路由信息的量级就是AS个数的量级，这比AS内部的网络数少很多

![image-20210110194949987](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110194949987.png)

### 路由器的组成

组成如下，在路由器设计中，怎样提高查找转发表的速率是一个十分重要的研究课题。

![image-20210110195150709](./%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110195150709.png)



### IP多播

了解一下概念即可，下图是单播和多播的对比：

![image-20210111212506418](https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210111212506418.png)

- 能够运行多播协议的路由器称为多播路由器(multicast router)。多播路由器当然也可以转发普通的单播IP数据报。
- 多播地址只能用于目的地址，而不能用于源地址。此外，对多播数据报不产生ICMP差错报文。因此，若在PING命令后面键入多播地址，将永远不会收到响应。

### VPN

即Virtual Private Network。

在局域网内部，并非每台机器都需要和外网相连，绝大多数的工作都是局域网内部传输数据，此时就可以组一个专有网络，局域网内部通过本地地址连接，对整个专有网络只申请一个外网地址用于外网连接。

这里要解决的问题：本地地址必须和外网地址不同，不然会出现本地地址和外网地址冲突的情况。为此，给出了有特殊用途的IP地址

(1) 10.0.0.0到10.255.255.255 （或记为10.0.0.0/8，它又称为24位块）

(2) 172.16.0.0到172.31.255.255 （或记为172.16.0.0/12，它又称为20位块）

(3) 192.168.0.0到192.168.255.255 （或记为192.168.0.0/16，它又称为16位块）

如果一个企业有两个分布在不同地域的专有网络，他们之间可以通过公共因特网连接，将起合并为一个专有网络，称为：虚拟专有网络，即VPN。

虚拟代表几乎是，因为实际上并不是。

举例子：路由器R1收到内部数据报后，发现其目的网络必须通过因特网才能到达，就把整个的内部数据报进行加密（这样就保证了内部数据报的安全），然后重新加上数据报的首部，封装成为在因特网上发送的外部数据报，其源地址是路由器R1的全球地址125.1.2.3，而目的地址是路由器R2的全球地址194.4.5.6。路由器R2收到数据报后将其数据部分取出进行解密，恢复出原来的内部数据报（目的地址是10.2.0.3），交付主机Y。

![image-20210110222508576](https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210110222508576.png)

### NAT

NAT，Network Access Translation，即网络地址转换。

用于专有网络内部的多个主机透过一个公网IP访问外网的情况。

![image-20210110222749723](https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210110222749723.png)

NAT通过NAT地址转换表实现地址转换。

![image-20210110222733595](https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210110222733595.png)

## 第五章节 - 运输层

运输层是整个网络结构中的关键层次，因此弄懂它非常非常非常重要。

### 为什么要有运输层

下图展示了运输层和网络层最重要的区别：网络层只能够负责主机到主机之间的通信，而运输层负责主机中进程之间的通信。

运输层向高层用户屏蔽了下面网络核心的细节（如网络拓扑、所采用的路由选择协议等），它使应用进程看见的就是好像在两个运输层实体之间有一条端到端的逻辑通信信道

只有主机的协议栈才有运输层，而网络核心部分中的路由器在转发分组时都只用到下三层的功能。

![image-20210111213801081](https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210111213801081.png)

### 运输层的两个主要协议

![image-20210111214230017](https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210111214230017.png)

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210111214319156.png" style="zoom:50%;" />

#### TCP

TCP则提供面向连接的服务。在传送数据之前必须先建立连接，数据传送结束后要释放连接。TCP不提供广播或多播服务。由于TCP要提供可靠的、面向连接的运输服务，因此不可避免地增加了许多的开销，如确认、流量控制、计时器以及连接管理等。这不仅使协议数据单元的首部增大很多，还要占用许多的处理机资源。

特点如下

- 面向连接：应用程序在使用TCP协议之前，必须先建立TCP连接。在传送数据完毕后，必须释放已经建立的TCP连接。

- 点对点：每一条TCP连接只能有两个端点(endpoint)，每一条TCP连接只能是点对点的（一对一）

- 可靠交付：通过TCP连接传送的数据，无差错、不丢失、不重复、并且按序到达

- 全双工通信：通信双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和接收缓存。

  在发送时，应用程序在把数据传送给TCP的缓存后，就可以做自己的事，而TCP在合适的时候把数据发送出去。

  在接收时，TCP把收到的数据放入缓存，上层的应用进程在合适的时候读取缓存中的数据。

-  面向字节流：“流”(stream)指的是流入到进程或从进程流出的字节序列。

  虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序交下来的数据看成仅仅是一连串的无结构的字节流。TCP并不知道所传送的字节流的含义。TCP不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系（例如，发送方应用程序交给发送方的TCP共10个数据块，但接收方的TCP可能只用了4个数据块就把收到的字节流交付上层的应用程序）。但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样。

TCP并不关心应用进程一次把多长的报文发送到TCP的缓存中，而是根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP发送的报文长度是应用进程给出的）。如果应用进程传送到TCP缓存的数据块太长，TCP就可以把它划分短一些再传送。如果应用进程一次只发来一个字节，TCP也可以等待积累有足够多的字节后再构成报文段发送出去。关于TCP报文段的长度问题，在后面还要进行讨论。

#### TCP连接

TCP连接的端点叫做套接字(socket)：根据RFC 793的定义，端口号拼接到(contatenated with) IP地址即构成了套接字。它是协议软件提供的一种抽象。

每一条TCP连接唯一地被通信两端的两个端点（即两个套接字）所确定。

#### TCP首部

TCP的全部功能都体现在它首部中各字段的作用，只有弄清TCP首部各字段的作用才能掌握TCP的工作原理。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210111224538369.png" alt="image-20210111224538369" style="zoom:80%;" />

- 源端口和目的端口：顾名思义

- 序号：字节序号。TCP是面向字节流的，这里记录了字节流中处于本报文段字节的序号，而不是报文段的序号。例如，一报文段的序号字段值是301，而携带的数据共有100字节。这就表明：本报文段的数据的第一个字节的序号是301，最后一个字节的序号是400。显然，下一个报文段（如果还有的话）的数据序号应当从401开始，即下一个报文段的序号字段值应为401。

  范围是[0, 2^32 - 1]，序号满时就又从0开始，在不满的情况下又4GB的空间。

- 确认号：期望收到对方下一个报文段的第一个数据字节的序号。这是接收方向发送方给出的。

- 数据偏移：它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。即首部长度。由于首部中含有长度可变的选项部分。因此该部分是有必要存在的。

- 控制位URG：当URG = 1时，表明紧急指针字段有效。

  它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)，而不要按原来的排队顺序来传送。

  例如发送数据途中按Ctrl+C，该报文就应该紧急传送，如果等到正常报文传输完成再传，则浪费事件。

  它和紧急指针联合使用才有意义。

- 控制位ACK：当ACK = 1时确认号字段才有效。TCP规定，在连接建立后所有传送的报文段都必须把ACK置1。

- 控制位PSH：推送操作。发送方TCP把PSH置1，并立即创建一个报文段发送出去。接收方TCP收到PSH = 1的报文段，就尽快地（即“推送”向前）交付接收应用进程，而不再等到整个缓存都填满了后再向上交付。

- 控制位RST：当RST = 1时，必须释放连接，然后再重新建立运输连接。RST置1还用来拒绝一个非法的报文段或拒绝打开一个连接。

- 控制位SYN：在连接建立时用来同步序号。当SYN = 1而ACK = 0时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使SYN = 1和ACK = 1。

- 控制位FIN：用来释放一个连接。当FIN = 1时，表明此报文段的发送方的数据已发送完毕，并要求释放运输连接。

- 窗口：窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。

- 检验和：顾名思义

- 紧急指针：URG = 1时才有意义，它指出本报文段中的紧急数据的字节数

  即一个报文段中既可以有紧急数据，也可以有正常数据，紧急指针就是用来区隔它们的

- 选项 长度可变，最长可达40字节。可能有的选项

  - 最大报文段长度 MSS：即当前报文（首部+数据）报文的最大长度，设置它的目的在于控制报文长度，使得其封装成IP报文后不至于太短，也不至于太长而被拆分成多个IP报文。
  - 时间戳：可用来计算往返时间；也可防止序号绕回，即序号满了又从0开始的情况。

#### TCP可靠传输原理

- 停止等待协议

  如下两个图说明了当传输出现差错时的处理方式：超时和迟到确认

  - 报文丢失时，发送方超时重发
  - 报文确认信息迟到时，发送方忽略后来的确认信息，接收方丢弃接收到的重复报文

  通过上述方式，能够实现可靠传输

  <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210111221319759.png" alt="image-20210111221319759" style="zoom:67%;" />

  <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210111221336466.png" style="zoom:67%;" />

- 连续ARQ协议

  单独的停止等待会造成信道利用率低，此时就用到连续ARQ协议，它给出一个窗口，在窗口内的报文可发送，接收到确认信息后，窗口后移。

  接收方一般都是采用累积确认的方式。这就是说，接收方不必对收到的分组逐个发送确认，而是在收到几个分组后，对按序到达的最后一个分组发送确认

  <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210111221607942.png" alt="image-20210111221607942" style="zoom:67%;" />

#### TCP可靠传输原理续

1. 以字节为单位的滑动窗口

   连续ARQ协议提出用滑动窗口解决问题，实际的滑动窗口并不是报文组，而是字节。

   <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210113224025035.png" style="zoom:80%;" />

   ![image-20210113224722828](https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210113224722828.png)

   如上图：在后沿的数据发送完成，即收到接收方的确认报文后，窗口前移。

   有几个需要注意的点：

   - B只能对**按序收到**的数据中的最高序号给出确认，因此B发送的确认报文段中的确认号仍然是31（即期望收到的序号），而不能是32或33。
   - 前面说的TCP发送方和接收方都有缓存，它们的作用分别是
     - 发送缓存用来暂时存放：发送应用程序传送给发送方TCP准备发送的数据；TCP已发送出但尚未收到确认的数据。
     - 接收缓存用来暂时存放：按序到达的、但尚未被接收应用程序读取的数据；未按序到达的数据。

2. 超时重传的时间选择

   前面说到了超时重传，多久算超时呢，计算方式如下：

   TCP采用了一种自适应算法，它记录一个报文段发出的时间，以及收到相应的确认的时间。这两个时间之差就是报文段的往返时间RTT。TCP保留了RTT的一个加权平均往返时间 RTTS（这又称为平滑的往返时间，S表示Smoothed。因为进行的是加权平均，因此得出的结果更加平滑）

   <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210113225131181.png" alt="image-20210113225131181" style="zoom:80%;" />

   α推荐取值为0.125

   问题：如何判定此确认报文段是对先发送的报文段的确认，还是对后来重传的报文段的确认？

   解决：报文段每重传一次，就把超时重传时间RTO增大一些。典型的做法是取新的重传时间为2倍的旧的重传时间。

3. 选择确认SACK

   前面说的必须按顺序接收才算，否则断开的序号后字节需要重传，这样可能会重传很多接收方已经成功接收的数据。于是有了SACK。它用来允许传输中间断掉的字节。

#### TCP的流量控制

流量控制，就是背压：让发送方的发送速率不要太快，要让接收方来得及接收。

使用TCP报文的发送窗口来限制流量控制。由于发送窗口是响应报文传给发送方的，用来做流量控制就很正常。

#### TCP的拥塞控制

拥塞：对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏。比如带宽不足。

拥塞控制：就是防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。

控制拥塞的几个方式：

1. 慢开始和拥塞避免

   发送方维持一个叫做拥塞窗口 cwnd (congestion window)的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。发送方让自己的发送窗口等于拥塞窗口。

   发送方控制拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数。

   慢开始算法的思路是这样的。当主机开始发送数据时，如果立即把大量数据字节注入到网络，那么就有可能引起网络拥塞，因为现在并不清楚网络的负荷情况。经验证明，较好的方法是先探测一下，即由小到大逐渐增大发送窗口，也就是说，由小到大逐渐增大拥塞窗口数值。通常在刚刚开始发送报文段时，先把拥塞窗口cwnd设置为一个最大报文段MSS的数值[插图]。而在每收到一个对新的报文段的确认后，把拥塞窗口增加至多一个MSS的数值。用这样的方法逐步增大发送方的拥塞窗口cwnd，可以使分组注入到网络的速率更加合理。

   <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210113230711152.png" alt="image-20210113230711152" style="zoom:80%;" />

   为了防止拥塞窗口cwnd增长过大引起网络拥塞，还需要设置一个慢开始门限 ssthresh状态变量（如何设置ssthresh，后面还要讲）。慢开始门限ssthresh的用法如下：

   当cwnd < ssthresh时，使用上述的慢开始算法。

   当cwnd > ssthresh时，停止使用慢开始算法而改用拥塞避免算法。

   当cwnd = ssthresh时，既可使用慢开始算法，也可使用拥塞避免算法。

   拥塞避免算法的思路是让拥塞窗口cwnd缓慢地增大，即每经过一个往返时间RTT就把发送方的拥塞窗口cwnd加1[插图]，而不是加倍。这样，拥塞窗口cwnd 按线性规律缓慢增长，比慢开始算法的拥塞窗口增长速率缓慢得多。

2. 快重传和快恢复

   太麻烦了，有需要自己去看，在5.8.2节

#### TCP连接管理

运输连接就有三个阶段，即：连接建立、数据传送和连接释放

1. 建立连接

   <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210113231113234.png" style="zoom:67%;" />

   - 客户端发送SYN报文
   - 服务端响应SYN报文，同时ACK置为1
   - 客户端响应服务端的响应报文

   为什么最后客户端要响应服务端响应的报文？

   客户端A收到B的响应报文后，可以确定进入连接状态；但B发出响应报文后，并不确定A是否已经接收到，因此需要响应才能进入连接状态。可以理解为双向确认。

   seq=x是什么意思？

   TCP规定SYN报文没有数据，但需要消耗一个序号，于是有了seq。

2. 断开连接

   <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210113231637561.png" alt="image-20210113231637561" style="zoom:67%;" />

   - A清空自己的缓存，发送FIN报文
   - B收到后回复ACK，A接收到后进入半关闭状态，即A不会发送数据了，但是还能接收来自B的数据；
   - B清空自己的缓存，发送FIN+ACK报文
   - A收到后回复ACK，然后等待一段时间，再完全关闭；B收到ACK后马上进入关闭状态

   为什么A最后要等待2MSL？

   - 保证最后一个报文能够到达B，如果没到达，则需要重传。

3. 为什么是三次握手，而挥手是四次

   - 三次握手时，服务器同时把ACK和SYN放在一起发送到了客户端那里
   - 四次挥手时，当收到对方的 FIN 报文时，仅仅表示对方不再发送数据了但是还能接收数据，己方是否现在关闭发送数据通道，需要上层应用来决定，因此，己方 ACK 和 FIN 一般都会分开发送。

#### UDP

UDP在传送数据之前不需要先建立连接。特点如下

- 无连接，发送数据前不需要连接
- 尽最大努力交付，即不保证可靠交付，因此主机不需要维护复杂的连接状态
- 面向报文，发送方的UDP对应用程序交下来的报文，在添加首部后就向下交付IP层。UDP对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。这就是说，应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文，因此，应用程序必须选择合适大小的报文。若报文太长，UDP把它交给IP层后，IP层在传送时可能要进行分片，这会降低IP层的效率。反之，若报文太短，UDP把它交给IP层后，会使IP数据报的首部的相对长度太大，这也降低了IP层的效率。
- 没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的。
- UDP支持一对一、一对多、多对一和多对多的交互通信
- UDP的首部开销小，只有8个字节，比TCP的20个字节的首部要短

其报文如下：

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210111215716314.png" alt="image-20210111215716314" style="zoom:67%;" />

其中伪首部并不是真正的首部，只是在计算校验和时使用，既不向上，也不向下传输。

### 端口

IP地址用来标识主机，端口则对应主机上的引用。端口指的是软件端口，注意和交换机路由器上的硬件端口进行区分。

**TCP/IP的运输层用一个16位端口号来标志一个端口**。但请注意，端口号只具有本地意义，它只是为了标志本计算机应用层中的各个进程在和运输层交互时的层间接口。在因特网不同计算机中，相同的端口号是没有关联的。

端口是有分类的：

- 系统端口号：数值为0～1023，这些数值可在网址www.iana.org查到。IANA把这些端口号指派给了TCP/IP最重要的一些应用程序

  入ssh为22，http为80，https为443

- 登记端口号：数值为1024～49151，使用这类端口号必须在IANA按照规定的手续登记，以防止重复

-  客户端使用的端口号：数值为49152～65535，提供给客户端程序短暂使用

## 第六章节 - 应用层

### FTP 文件传输协议

File Transfer Protocol，即文件传输协议。对应的运输层是TCP协议。

从一台计算机将文件传输到另一台计算机所面临的难点

- 不同计算机存储的数据格式不同
- 文件的目录结构和文件名的规定不同
- 对于相同的文件的存取功能，操作系统使用的命令不同
- 访问控制方法不同

而FTP的主要作用是消除不同操作系统下处理文件的不兼容性。

#### 原理

FTP使用两个TCP连接，并且这两个连接分别使用不同的端口。一个连接用于控制，另一个连接用于数据传输。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210117113823857.png" alt="image-20210117113823857" style="zoom:80%;" />

FTP会传输整个文件，而不能传输部分。比如实现修改某个文件的一小部分，使用FTP需要将整个文件传输，修改了该部分后再传回去，向当地浪费资源。

### NFS 网络文件系统

Network File System

上面说了FTP不能传输文件的一部分，NFS就是用来解决这个问题的。

NFS允许应用进程打开一个远程文件，并在该文件的某个特定的位置开始读写数据。

### TELNET 远程终端控制协议

TELNET能够让本地TCP连接注册到远程主机。将用户的操作入点击鼠标传到远程主机，同时也能将远程主机的输出通过TCP连接返回到用户屏幕。整个操作对用户来说是透明的。

### 万维网 WWW

**超文本：即包含指向其它文档的连接的文本。**超文本是万维网的基础。

万维网需要解决的问题及它提供的解决方案：

- 如何标识分布在整个因特网上的文档 —— URL，即统一资源定位符
- 用什么样的协议来实现各种链接——HTTP协议，即超文本传输协议
- 如何组织超文本——HTML，即超本文标记语言
- 怎样使用户方便地找到所需信息——浏览器

#### URL

格式：<协议>://<主机>:<端口>/<路径>

举例：https://weread.qq.com/web/reader/af532c005a007caf51371b1k025324d028602522a2b2084

URL相当于一组文件名在网络上的扩展。

#### HTTP

特点

- 面向事务的，即
- 无连接，即发送数据前不需要建立连接
- 无状态，即服务器不会记录http的访问历史，两次http访问之间并无关联

HTTP1.1和1.0特点对比

- 持续连接：1.0中，每次发送数据时，都要重新建立TCP连接。1.1中，一个TCP连接保留很久，给多个HTTP请求使用同一个连接，节省TCP连接的建立和释放事件。
- pipeling，即流水线方式：1.0中，每次http请求发送了都要等待响应后再发送下一个请求，这叫做非流水线方式，浪费了TCP连接的空闲时间；1.1中，一个http请求发送后可以不用等待响应而直接发送下一个http请求，响应后再和之前的请求对应上，这叫做流水线方式。

HTTP的报文格式如下，主要分为三部分

- 开始行：用它来区分是请求报文还是响应报文。请求报文这部分叫做请求行；响应报文这部分叫做状态行
- 首部行：带一些Header，相当于元数据，用于说明浏览器、服务器、报文的一些信息
- 实体：即带的实体消息

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210117160014369.png" alt="image-20210117160014369" style="zoom:80%;" />

可以看到，请求报文和响应报文格式上唯一的不同点就是开始行。

关于Cookie

从协议上说，服务端响应报文的头部Set-Cookie:xxx就表示要在浏览器中设置一个值为xxx的Cookie，浏览器会将其保存；下次访问时，通过Cookie:xxx这样的头部带上

#### 代理服务器

代理服务器(proxy server)是一种网络实体，它又称为万维网高速缓存(Web cache)。代理服务器把最近的一些请求和响应暂存在本地磁盘中。当新请求到达时，若代理服务器发现这个请求与暂时存放的请求相同，就返回暂存的响应，而不需要按URL的地址再次去因特网访问该资源。代理服务器可在客户端或服务器端工作，也可在中间系统上工作

#### 万维网的文档

- CGI: Common Gateway Interface，通用网关接口。是一种标准，定义了动态文档如何创建。叫做网关是因为在生成文档前可能还要访问数据库等其它服务器资源。

  CGI程序的正式名称是CGI脚本。又称为cgi-bin脚本，这是因为很多服务器将它们放在/cgi-bin目录下。

- 脚本：脚本指的是一个程序是被另一个程序而不是计算机的处理机来解释或执行。

  有专门的脚本语言，入Perl、JS等。但运行起来相对较慢。

#### 博客、微博

- 博客：是万维网日志的简称。即web log。用来分享较为完整的文章。主要用于知识分享。
- 微博：相对博客更加短小，主要用于状态分享。

### 电子邮件

SMTP：Simple Mail Transfer Protocol，即简单邮件传输协议，是邮件发送的协议。

POP3：Post Office Protocol第三版，即邮局协议，收件人从邮件服务器读取邮件使用的协议。

整个邮件的发送过程如下：

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210119223449411.png" alt="image-20210119223449411" style="zoom:80%;" />

- 发件人/收件人客户代理，就是电子邮箱客户端，如Gmail、Foxmail等客户端，网页上的也算。

电子邮件组成部分

- envelope：信封，其中最重要的内容是邮件地址，比如zouguodong@gmail.com
- content：内容

#### SMTP

SMTP规定了在两个SMTP进程间如何通信，这里说明它的主要工作流程。

- 建立连接

  - 发件人的邮件送到发送方邮件服务器的邮件缓存后，SMTP客户就每隔一定时间(例如30分钟)对邮件缓存扫描一次。
  - 如发现有邮件，就使用SMTP的熟知端口号码(25)与接收方邮件服务器的SMTP服务器建立TCP连接。
  - 在连接建立后，接收方SMTP服务器要发出“220 Service ready”（服务就绪）。
  - 然后SMTP客户向SMTP服务器发送HELO命令，附上发送方的主机名。SMTP服务器若有能力接收邮件，则回答：“250 OK”，表示已准备好接收。若SMTP服务器不可用，则回答“421 Service notavailable”（服务不可用）。
  - 如在一定时间内(例如三天)发送不了邮件，邮件服务器会把这个情况通知发件人。

  注意：SMTP不经过中间的邮件服务器，不管发送方和接收方相隔多远，TCP连接都是直接建立的。当连接无法建立时，只能等待一段时间再尝试连接，而不能找其它中间服务器。

- 邮件传送

  依次由几个内容

  - MAIL：如：MAIL FROM:<xiexiren@tsinghua.org.cn>。若SMTP服务器已准备好接收邮件，则回答“250 OK”。否则，返回一个代码，指出原因。如：451（处理时出错），452（存储空间不够），500（命令无法识别）等。

  - RCPT：RCPT是recipient（收件人）的缩写。每发送一个RCPT命令，都应当有相应的信息从SMTP服务器返回，如：“250 OK”，表示指明的邮箱在接收方的系统中。或“550 No suchuser here”（无此用户），即不存在此邮箱。

    RCPT命令的作用就是：先弄清接收方系统是否已做好接收邮件的准备，然后才发送邮件。这样做是为了避免浪费通信资源

  - DATA：发送真正的数据

- 连接释放

  邮件发送完毕后，SMTP客户应发送QUIT命令。SMTP服务器返回的信息是“221 （服务关闭）”，表示SMTP同意释放TCP连接。邮件传送的全部过程即结束。

#### 发送成功不一定被读取

发送成功只是邮件到达了接收服务器，由好几种可能导致接收不成功

- 接收方服务器收件成功后马上就出了故障
- 被收件服务器当作垃圾邮件删除

#### 电子邮件信息格式

前面说了，电子邮件分为信封和内容。内容中，标准只规定了header格式，而body则由用户自由撰写。header主要有如下关键字

- To：收件人
- Subject：主题
- Cc：抄送，全写Carbon Copy
- Bcc：密送，即发送给收件人，但不希望被收件人知道。全写Blind Carbon Copy
- From：发件人，一般由系统填充
- Date：发送日期，一般由系统填充
- Reply-To：对方回信所用地址，可以与发件人不一样

#### POP3

POP是邮件读取协议

POP也采用客户-服务器的工作方式，POP服务端也运行在邮件接收服务器上，POP服务器只有在用户输入鉴别信息（用户名和口令）后，才允许对邮箱进行读取。这有时候会成为一个问题，后续出台标准的解决方式是延长读取后还存在POP服务器上的时间。

#### IMAP

IMAP是另一个邮件读取协议，它比POP3复杂得多。

在使用IMAP时，在用户的PC上运行IMAP客户程序，然后与接收方的邮件服务器上的IMAP服务器程序建立TCP连接。用户在自己的PC上就可以操纵邮件服务器的邮箱，就像在本地操纵一样，因此IMAP是一个联机协议。当用户PC上的IMAP客户程序打开IMAP服务器的邮箱时，用户就可看到邮件的首部。若用户需要打开某个邮件，则该邮件才传到用户的计算机上。

IMAP最大的好处就是用户可以在不同的地方使用不同的计算机随时上网阅读和处理自己的邮件

#### 我们最常用的网页邮件？

像QQ邮箱这种通过网页查看的，叫做基于万维网的电子邮件。它在结构上和上面说的有些差别。

如下，客户端发送到发件服务器，是通过HTTP而不是SMTP发送，发件服务器和收件服务器之间还是用SMTP传输，收件客户从收件服务器上拉取邮件时是通过HTTP而不是POP3或IMAP。这点注意区分。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210119231117749.png" alt="image-20210119231117749" style="zoom:80%;" />

#### 通用因特网邮件扩充MIME

MIME是对SMTP的扩充，并没有改变SMTP协议，只是对主体进行了扩展

- 增加5个首部字段

  - MIME-Version: 标志MIME的版本。现在的版本号是1.0。若无此行，则为英文文本。

  - Content-Description: 这是可读字符串，说明此邮件主体是否是图像、音频或视频。

  - Content-Id: 邮件的唯一标识符。

  - Content-Transfer-Encoding: 在传送时邮件的主体是如何编码的。

  - Content-Type: 说明邮件主体的数据类型和子类型。

    <img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20210119232804674.png" alt="image-20210119232804674" style="zoom:67%;" />

- 定义了许多邮件内容格式，对多媒体电子邮件的表示方法进行了标准化。

- 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变。

### 动态主机配置协议DHCP

为了把协议软件做成通用的和便于移植，协议软件的编写者不会把所有的细节都固定在源代码中，而是以参数得形式写入。在协议软件中给这些参数赋值的动作叫做协议配置。在协议软件中给这些参数赋值的动作叫做**协议配置**。

DHCP主要是给新加入网络的主机分配IP地址用的，也使用客户-服务器方式。主要步骤如下

- 新主机由于没有被分配IP，将自己的IP设为0.0.0.0，然后向网络广播DHCP发现报文（DHCPDISCOVER）（将目的IP地址置为255.255.255.255）
- 本地网络所有主机都收到该发现报文，但只有DHCP服务器才会对此做出回应，如果已经由该主机的IP，则直接返回，若没有，则从IP地址池中选择一个分配。DHCP服务器的回答报文叫做提供报文（DHCPOFFER）

**租期**

DHCP服务器分配给DHCP客户端的IP地址是临时的，这个临时的时间段叫做租期，租用期用4字节的二进制数字表示，单位是秒。因此可供选择的租用期范围从1秒到136年，可配。客户端需要续租，否则IP将被收回。



# 不是说IP地址耗尽了吗？为什么我们还能用？

因为又VPN和NAT的存在

# 阿里云提供的哪些内网IP，为什么总是以172\192之类的开头？



# 《高性能Linux服务构建实战》



# 《Devops入门与实践》



# 《白帽子讲web安全》



# 《Kubernetes微服务实战》



# 《Kubernetes实战》