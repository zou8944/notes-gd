# 《蜕变：从菜鸟到Linux安全专家》

> 按优先级，依次查看如下章节
>
> - 第十一章
> - 第十二章
> - 第九章

## 防火墙

其实，iptables与firewalld都不是真正的防火墙，它们都只是用来定义防火墙策略的防火墙管理工具而已，或者说，它们只是一种服务。iptables服务会把配置好的防火墙策略交由内核层面的netfilter网络过滤器来处理，而firewalld服务则是把配置好的防火墙策略交由内核层面的nftables包过滤框架来处理。

在早期的Linux系统中，默认使用的是iptables防火墙管理服务来配置防火墙。尽管新型的firewalld防火墙管理服务已经被投入使用多年，但是大量的企业在生产环境中依然出于各种原因而继续使用iptables。

### iptables

- iptables命令可以根据流量的源地址、目的地址、传输协议、服务类型等信息进行匹配，一旦匹配成功，iptables就会根据策略规则所预设的动作来处理这些流量。
- 防火墙策略规则的匹配顺序是从上至下的，因此要把较为严格、优先级较高的策略规则放到前面，以免发生错误。

具体操作：https://www.linuxprobe.com/chapter-08.html



### firewalld

- 还差网络基础知识，先补全基础再来看。https://www.linuxprobe.com/chapter-08.html



# 《计算机网络》

> 按优先级，依次学习如下章节
>
> - 第一章
>   - 1.6
>   - 1.7
> - 第二章
>   - 2.6
> - 第三章
>   - 整章
> - 后面的每一章

## 第一章节

计算机网络几个指标

- 速率
- 带宽：速率的最大值
- 吞吐量：感觉和带宽差不多的概念

这三个概念差不多

## 第二章节 - 物理层

### OSI和TCP/IP啥关系

OSI全称OSI/RM(Open System Interconnection Reference Model，开放系统互联协议)，1983年提出，试图让全世界的网络标准都遵循这个统一的标准。但是几乎没有什么计算机产品遵循这个标准，原因是

- 专家缺乏实际经验
- 实现过于复杂，运行效率低
- 标准指定周期长
- 层次划分不合理，部分功能在多个层中多次出现

TPC/IP是一个参考OSI并进行简化的模型，是事实上的标准。与OSI这个法律上的标准形成了鲜明的对比。

### 要学习的模型

OSI是7层，事实上的标准TCP/IP是四层，而为了更好地学习计算机网络的各层，选择综合OSI和TCP/IP的优点，拿出一个5层协议的体系结构进行学习。

注意并不是真的由这样一个体系结构，这只是为了方便我们学习的模型。

![image-20201129154956764](https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129154956764.png)

### 宽带接入

- 如果用户要连接到公网，必须先连接到某个ISP，以便获得上网所需的IP地址。

### ADSL

非对称数字用户线ADSL（Asymmetric Digital Subscriber Line）技术是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带数字业务。虽然标准模拟电话信号的频带被限制在300～3 400Hz的范围内（这是电话局的交换机设置的标准话路频带），但用户线本身实际可通过的信号频率却超过1MHz。ADSL技术把0～4kHz低端频谱留给传统电话使用，而把原来没有被利用的高端频谱留给用户上网使用。ADSL的ITU的标准是G.992.1 （或称G.dmt，表示它使用DMT技术，见后面的介绍）。由于用户在上网时主要是从因特网下载各种文档，而向因特网发送的信息量一般都不太大，因此ADSL的下行（从ISP到用户）带宽都远远大于上行（从用户到ISP）带宽。“非对称”这个名词就是这样得出的。

ADSL在用户线（铜线）的两端各安装一个ADSL调制解调器。

ADSL最大的好处就是可以利用现有电话网中的用户线，不需要重新布线。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129161130207.png" alt="image-20201129161130207" style="zoom:70%;" />

实际家中使用时，看起来只是接了一个ADSL调制解调器就能够使用电话线来上网了，实际上在电话线另外一头还有一个电话局的调制解调器用于解析获取用户的上网信息。而电话线中电话部分的信号则被低通滤波器过滤，依旧传输到原电话服务。

也就是说，ADSL只是利用了电话线进行传输而已，省去了布线的成本。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129161547234.png" alt="image-20201129161547234" style="zoom:67%;" />

### 光纤同轴混合网（HFC网）

### FTTx技术

## 第三章节 - 数据链路层

### 链路和数据链路的区别

所谓**链路(link)**就是从一个结点到相邻结点的一段物理线路（有线或无线），而中间没有任何其他的交换结点。在进行数据通信时，两个计算机之间的通信路径往往要经过许多段这样的链路。可见链路只是一条路径的组成部分。

**数据链路(data link)**则是另一个概念。这是因为当需要在一条线路上传送数据时，除了必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输（这将在后面几节讨论）。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。现在最常用的方法是使用网络适配器（既有硬件，也包括软件）来实现这些协议。一般的适配器都包括了数据链路层和物理层这两层的功能。

我的理解：数据链路包括硬件和软件，而这个级别的软件是类似I2C、串口之类的硬件层协议，是规定数据如何在物理链路中传播的协议。而数据链路层的协议数据单元——帧也从侧面证实了这一点。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129170134467.png" alt="image-20201129170134467" style="zoom:67%;" />

### 数据链路层要解决的三个基本问题

- 封装成帧

  数据加上头尾就成了一个完整可传输的帧。

- 透明传输

  帧必须是可透明传输的，即不管数据中包含何种字符，都应该能够成功。对于特殊字符，在前面加上转义符即可。

- 错误侦测

  主要是检测数据传输是否有误，可以使用CRC校验之类的算法校验。对于校验失败的可以进行重传。

### 点对点传输 - PPP协议

因特网用户通常都要连接到某个ISP才能接入到因特网。PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议。

#### 特点

- 简单

  IETF在因特网设计时将最复杂的部分放在了TCP协议中，网际协议IP则相对比较简单，更下层的数据链路层协议没有必要更复杂。PPP协议简单到什么程度呢？——接收方每收到一个帧，就进行CRC检验。如CRC检验正确，就收下这个帧；反之，就丢弃这个帧，其他什么也不做。

- 满足上面说的三个基本问题

- 支持多种网络层协议

  这是通过在帧中添加协议类型位做到的。

- 支持多种类型的链路

  除了要支持多种网络层的协议外，PPP还必须能够在多种类型的链路上运行。例如，串行的（一次只发送一个比特）或并行的（一次并行地发送多个比特），同步的或异步的，低速的或高速的，电的或光的，交换的（动态的）或非交换的（静态的）点对点链路

  PPOE就是一个典型的例子（详情见后面分析）

- 检测连接状态

  可自动检测出链路是否处于正常工作状态

**在TCP/IP协议族中，可靠传输由运输层的TCP协议负责，因此数据链路层的PPP协议不需要进行纠错**，不需要设置序号，也不需要进行流量控制。PPP协议不支持多点线路（即一个主站轮流和链路上的多个从站进行通信），而只支持点对点的链路通信。此外， PPP协议只支持全双工链路。

#### 组成

- 将IP数据报封装到串行链路的方法。PPP既支持异步链路（无奇偶检验的8比特数据），也支持面向比特的同步链路。
- 一个链路控制协议LCP：用于建立、配置和测试数据链路连接
- 一套网络控制协议NCP：每一个协议支持不同的网络层协议，如IP、OSI的网络层、DECnet，以及AppleTalk

#### 帧格式

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129203118779.png" alt="image-20201129203118779" style="zoom:67%;" />

注意其中的协议部分

- 0x0021时，表示该帧传输的是IP数据报
- 0xC021时，表示该帧传输的是LCP数据
- 0x8021时，表示该帧传输的是网络层的控制数据

#### 工作状态

PPP的工作过程

- 用户拨号连接ISP，建立了一条从用户PC到ISP的物理连接（通常是点击连接按钮）

- LCP协商：PC向ISP发送LCP分组（被封装成多个PPP帧），用于协商PPP参数，参数包括

  - 最大帧长度
  - 要使用的鉴别协议

- 鉴别（如果需要），支持两种鉴别方式

  - PAP（Password Authentication Protocol）：发起通信的一方给出身份标识和口令
  - CHAP（Chanllenge-HandShake Authentication Protocol）：

- NCP协商：PC向ISP发送NCP分组，协商网络协议，明白对方使用何种网络协议。这样，即使两端使用不同的网络协议，依然能够通过PPP传递消息

  如果是IP协议，则对PPP链路的每一端配置IP协议模块（如分配IP地址）时就要使用NCP中支持IP的协议——IP控制协议IPCP (IP Control Protocol)。

- LCP终止，一方发出终止请求，另一方响应。到达终止状态。

用图片表示如下。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129203833379.png" alt="image-20201129203833379" style="zoom:67%;" />

#### 所以？

PPP中，最先要建立物理连接，然后LCP协议协商链路控制，再NCP协商网络协议，因此PPP已经不纯粹是数据链路层的协议了，还包括了物理层和网络层的东西。

### 广播信道传输 - CSMA-CD协议

#### 局域网简介

局域网最主要的特点是：网络为一个单位所拥有，且地理范围和站点数目均有限。

局域网内各主机共享信道，使用了随机接入的方法：用户随机的发送消息，但如果恰巧有两个或更多的用户在同一时刻发送信息，那么在共享媒体上就要产生碰撞（即发生了冲突），使得这些用户的发送都失败。因此，必须有解决碰撞的网络协议

#### 什么是以太网

以太网是1975年研制成功的一种局域网，用无缘电缆作为总线，并用曾经标识电磁波的以太命名，得名以太网。Ethernet。

后来，提出了DIX Ethernet V2和802.3两个局域网标准，都称为以太网。

再后来，TCP/IP体系经常使用的局域网只剩下DIX Ethernet V2而不是IEEE 802.3标准中的局域网。因此以太网专门指DIX Ethernet V2标准的局域网。

以太网有两个特点

- 采用灵活的无连接的工作方式，不建立连接即可发送数据，数据的完整性由上层协议入TCP来保证。
- 数据发送采用曼彻斯特编码

#### LLC和MAC层

为了使数据链路层能更好地适应多种局域网标准，IEEE 802委员会就把局域网的数据链路层拆成两个子层，即逻辑链路控制 LLC (Logical Link Control)子层和媒体接入控制MAC (Medium Access Control)子层。与接入到传输媒体有关的内容都放在MAC子层，而LLC子层则与传输媒体无关。

LLC是802.3标准的内容，随着它的消失，LLC层也消失了。只剩下MAC层。

#### 网卡的作用

计算机与外界局域网连接是通过通信适配器，它就是网卡。

网卡上包含处理器和存储器，网卡通过有线或无线同局域网相连，通过计算机主板的IO总线与CPU相连。它的作用如下

- 将CPU传输的数据转换为穿行数据输出给局域网。而CPU速率和网络速率不一致，因此需要网卡上有缓存将数据存起来
- 适配器接收和发送各种帧时不使用计算机的CPU。这时CPU可以处理其他任务。当适配器收到有差错的帧时，就把这个帧丢弃而不必通知计算机。当适配器收到正确的帧时，它就使用中断来通知该计算机并交付协议栈中的网络层。当计算机要发送IP数据报时，就由协议栈把IP数据报向下交给适配器，组装成帧后发送到局域网。

注意点

- 计算机在网络中的硬件地址，其实就是网卡地址，存储在网卡的ROM中的
- 计算机的IP地址，则是存储在计算机自己的存储器中的

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129212311198.png" alt="image-20201129212311198" style="zoom:67%;" />

#### CSMA/CD

CSMA/CD，意思是载波监听多点接入/碰撞检测(Carrier Sense Multiple Access with Collision Detection)

上面有说，局域网各主机共享信道，采用随机接入的方法，主机随机发言，如果有两个主机同时发言，就产生了碰撞，CSMA/CD解决了这个问题。

要点

- 多点接入：就是说明这是总线型网络，许多计算机以多点接入的方式连接在一根总线上

- 载波监听”就是用电子技术检测总线上有没有其他计算机也在发送。其实总线上并没有什么“载波”，这里只不过借用一下“载波”这个名词而已。因此载波监听就是检测信道，这是个很重要的措施。

  不管在发送前，还是在发送中，每个站都必须不停地检测信道。在发送前检测信道，是为了获得发送权。如果检测出已经有其他站在发送，则自己就暂时不许发送数据，必须要等到信道变为空闲时才能发送。在发送中检测信道，是为了及时发现有没有其他站的发送和本站发送的碰撞。这就称为碰撞检测。

  碰撞检测”也就是“边发送边监听”，即适配器边发送数据边检测信道上的信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。

- 这就意味着，以太网在发送过程中要不停地检测信道

**感觉这样数据交换效率很低呀，怎么解决的呢**。

### 广播信道传输 - 以太网

CSMA/CD是工作在总线型的局域网的协议，而总线局域网已被淘汰。

#### 新的局域网

新的局域网采用星形连接，核心部件是集线器。

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129220342053.png" alt="image-20201129220342053" style="zoom:67%;" />

特点

- 使用集线器的以太网在逻辑上仍是一个总线网，各主机共享逻辑上的总线，使用的还是CSMA/CD协议

  集线器只是用电子器件模拟实际电缆的工作

- 1个集线器有许多接口[插图]，例如，8至16个，每个接口通过RJ-45插头

- **集线器工作在物理层，它的每个接口仅仅简单地转发比特**——收到1就转发1，收到0就转发0，不进行碰撞检测。

- 集线器采用了专门的芯片，进行自适应串音回波抵消。这样就可使接口转发出去的较强信号不致对该接口接收到的较弱信号产生干扰

#### 以太网的信道利用率

以太网的利用率由于碰撞的存在，会导致信道利用率达不到100%

#### 以太网的MAC层

在局域网中，硬件地址又称为物理地址或 MAC地址（因为这种地址用在MAC帧中）。MAC地址存储在网卡的ROM中。

**MAC地址的划分**

- IEEE的注册管理机构RA (Registration Authority)是局域网全球地址的法定管理机构[W-IEEERA]，它负责分配地址字段的6个字节中的前三个字节(即高位24位)。

  世界上凡要生产局域网适配器的厂家都必须向IEEE购买由这三个字节构成的这个号（即地址块），这个号的正式名称是组织唯一标识符OUI (Organizationally Unique Identifier)，通常也叫做公司标识符(company_id)。

  但应注意，24位的OUI不能够单独使用来标志一个公司，因为一个公司可能有几个OUI，也可能有几个小公司合起来购买一个OUI。

- IEEE规定地址字段的第一字节的最低位为I/G位。I/G表示Individual/Group。当I/G位为0时，地址字段表示一个单个站地址。当I/G位为1时表示组地址，用来进行多播（以前曾译为组播）。因此，IEEE只分配地址字段前三个字节中的23位。当I/G位分别为0和1时，一个地址块可分别生成224个单个站地址和224个组地址。

**MAC帧**

这里只介绍DIX Ethernet V2标准的帧

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129221832835.png" alt="image-20201129220342053" style="zoom:67%;" />

- 其中的类型表示网络层的协议类型，决定了数据被提交给何种协议处理
  - 0x0800：IP数据包
  - 0x8137：Novell IPX数据包

#### 在数据链路层扩展以太网

**网桥**

在数据链路层扩展以太网要使用网桥(bridge)。**网桥工作在数据链路层，它根据MAC帧的目的地址对收到的帧进行转发和过滤**。

网桥依靠转发表来转发帧。转发表也叫做转发数据库或路由目录。转发表记录了以太网中主机和网桥接口的对应关系。

而转发表是可以自学习的来的，这很容易，因为发送到网桥上的帧由来源主机和对应的接口。

**源路由网桥**

网桥每次都是被动的选择帧传输路径，会造成资源使用不充分。

为此产生了源路由网桥，它先来一个发现帧，传输到目标主机再返回，记录沿途所有路由，下次发送时直接按照这个路由走就行了。

**以太网交换机**

以太网交换机实质上就是一个多接口的网桥。和工作在物理层的转发器、集线器有很大的差别。

因为二层交换机记录了接口和MAC地址的关系，由路由功能。而集线器只是对数据位的单纯转发，不管其逻辑意义。

**交换机实现VLAN**

VLAN是在802.1Q标准中提出的。

虚拟局域网VLAN是由一些局域网网段构成的与物理位置无关的逻辑组，而这些网段具有某些共同的需求。

其实现方式是在MAC帧中插入VLAN ID

<img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/notes/image-20201129223955614.png" alt="image-20201129223955614" style="zoom:67%;" />

记住，VLAN是通过二层交换机实现的。

### 高速以太网

速率达到或超过100Mb/s的以太网称为高速以太网

#### 100BASE-T以太网

100BASE-T是在双绞线上传送100Mb/s基带信号的星型拓扑以太网，仍使用IEEE 802.3的CSMA/CD协议，它又称为快速以太网(Fast Ethernet)。用户只要更换一个适配器，再配上一个100Mb/s的集线器，就可很方便地由10BASE-T以太网直接升级到100Mb/s，而不必改变网络的拓扑结构。

#### 吉比特以太网

目前市场上出售的各种计算机的以太网接口，已基本上都是1Gb/s的

吉比特以太网的标准IEEE 802.3z有以下几个特点：

(1) 允许在1Gb/s下全双工和半双工两种方式工作。

(2) 使用IEEE 802.3协议规定的帧格式。

(3) 在半双工方式下使用CSMA/CD协议（全双工方式不需要使用CSMA/CD协议）。

(4) 与10BASE-T和100BASE-T技术向后兼容。

#### 10吉比特和100吉比特以太网

### 使用以太网进行宽带接入

以太网接入的一个重要特点是它可以提供双向的宽带通信，并且可以根据用户对带宽的需求灵活地进行带宽升级（例如，把10兆的以太网交换机更新为100兆甚至吉比特的以太网交换机）。

然而以太网的帧格式标准中，在地址字段部分并没有用户名字段，也没有让用户键入密码来鉴别用户身份的过程。如果网络运营商要利用以太网接入到因特网，就必须解决这个问题。

于是有人就想法子把数据链路层的两个成功的协议结合起来，即把PPP协议中的PPP帧再封装到以太网中来传输。这就是1999年公布的PPPoE (PPP over Ethernet)，意思是“在以太网上运行PPP”





### 网卡的过滤功能

MAC帧的类型

(1) 单播(unicast)帧（一对一），即收到的帧的MAC地址与本站的硬件地址相同。

(2) 广播(broadcast)帧（一对全体），即发送给本局域网上所有站点的帧（全1地址）。

(3) 多播(multicast)帧（一对多），即发送给本局域网上一部分站点的帧。

以太网适配器还可设置为一种特殊的工作方式，即混杂方式(promiscuous mode)。工作在混杂方式的适配器只要“听到”有帧在以太网上传输就都悄悄地接收下来，而不管这些帧是发往哪个站。

但混杂方式有时却非常有用。例如，网络维护和管理人员需要用这种方式来监视和分析以太网上的流量，以便找出提高网络性能的具体措施。有一种很有用的网络工具叫做嗅探器(Sniffer)就使用了设置为混杂方式的网络适配器。此外，这种嗅探器还可帮助学习网络的人员更好地理解各种网络协议的工作原理。因此，混杂方式就像一把双刃剑，是利是弊要看你怎样使用它。

- 以太网、快速以太网，它们到底是啥？

## 第四章 - 网络层

### 网络层的设计思路

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。网络在发送分组时不需要先建立连接。每一个分组（也就是IP数据报）独立发送，与其前后的分组无关（不进行编号）。网络层不提供服务质量的承诺。**这样能够使网络层的路由器做得比较简单，并且价格相对低廉**。

如果通信需要是可靠的，那么则由运输层去控制：包括差错处理、流量控制。

如果在网络层去做可靠传输，就是将复杂度转移到了网络层，白白浪费了计算机的强大处理能力。

### 几个协议

- IP：是重要的英特网标准协议之一
- ARP： 地址解析协议
- ICMP：网络控制报文协议
- IGMP：网际组管理协议

它们在网络层中的关系如下图所示。

![image-20210110154935578](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110154935578.png)

网际层：由于网际协议IP是用来使互连起来的许多计算机网络能够进行通信，因此TCP/IP体系中的网络层常常称为网际层(internetlayer)，或IP层。

#### ARP

地址解析协议的作用：根据一个机器的IP地址找出相应的硬件地址，以将网络层报文在数据链路层进行传输。

协议原理：

- 原理：在主机ARP高速缓存中应存放一个从IP地址到硬件地址的映射表，并且这个映射表还经常动态更新（新增或超时删除）。
- 映射关系添加方式：主机B刚加入时没有映射关系怎么办，此时主机A在局域网广播ARP请求，告诉所有其它主机自己的IP和硬件地址，并查找期望的IP对应的硬件地址，此时主机B记录下主机A的映射关系，并回复自己的映射关系。然后映射建立成功。
- 注意多个局域网互联成一个局域网的情况，此时存储的ARP映射并非直接，而是会经过路由器转发的。

PS：**ARP到底算网络层还是数据链路层？由于其是使用IP地址查找硬件地址，因此可以算作网络层；但又因为找出的硬件地址在数据链路层使用，因此也可以算作数据链路层。两种分法都算OK的。**

**疑问：既然最终都要使用物理地址传输，为何不一开始就用物理地址传输呢？**

由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此由用户或用户主机来完成这项工作几乎是不可能的事。但统一的IP地址把这个复杂问题解决了。

####　ICMP

使用ICMP是为了有效地转发数据报和提高交付成功的机会：ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告

听起来可能有点奇怪，但看了ICMP的报文类型你一下子就能明白了。

![image-20210110183246277](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110183246277.png)

##### 差错报告报文

- 终点不可达：当路由器或主机不能交付数据报时就向源点发送终点不可达报文
- 源点抑制：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。
- 时间超过：当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。
- 参数问题：当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
- 改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

##### 询问报文

- 回送请求和回答：用于测试目的站是否可达，以了解其有关状态。
- 时间戳请求和回答：用于进行时间同步和测量时间。ICMP时间戳请求报文是请某个主机或路由器回答当前的日期和时间。

##### 应用举例

- **ping**：使用了询问报文回送请求和回答

- **traceroute**：它用来跟踪一个分组从源点到终点的路径

  原理：向目的主机发送一连串IP数据报文，第一个报文设置TTL为1，当到达第一个路由器R1时，TTL被减1，变成0，R1就将报文丢弃，并向源主机发送差错报告报文“时间超过”；以此类推，就能跟踪出整个路径。

##### 为什么我的traceroute路径上出现星号

因为ICMP报文类型是可以被封的，如果被封了，就看不到了。

### 几个中间设备

- 转发器：物理层使用的中间设备
- 网桥：数据链路层使用的中间设备
- 路由器：网络层使用的中间设备：路由器其实就是一台专用计算机，用来在互联网中进行路由选择。
- 网关：网络层以上使用的中间设备。用网关连接两个不兼容的系统需要在高层进行协议的转换。

### IP的编址方法

IP地址的编址方法总共经过三个历史阶段

- 分类的IP地址：基本的编址方法，1981年通过
- 子网的划分：对基本编址方法的改进，1985年通过
- 构成超网：新的无分类编址方法，1993年提出后很快得到推广和应用

#### 分类的IP地址

首先说明，分类的IP地址已经成为历史，学习它有助于了解编址方法的演进。

如下图所示，被分为A-E几类地址，ABC为单播地址；D为多播地址；E保留为今后使用。

单播地址中，又分为网络号和主机号，这样区分的考虑：各种网络的差异很大，有的网络拥有很多主机，而有的网络上的主机则很少。把IP地址划分为A类、B类和C类是为了更好地满足不同用户的要求。当某个单位申请到一个IP地址时，实际上是获得了具有同样网络号的一块地址。其中具体的各个主机号则由该单位自行分配，只要做到在该单位管辖的范围内无重复的主机号即可。

![image-20210110160807635](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110160807635.png)

##### A类地址

- 网络号全0：IP地址中的全0表示this，因此网络号全0表示本网络
- 网络号127：网络号为127被保留作为本地软件的回环测试。当向127开头的IP地址请求时，软件协议会直接处理该请求，而不会发送到任何网络上。因此网络上不可能出现它

- 主机号全0：表示本主机所连接到的单个网络地址
- 主机号全1：表示当前网络上的所有主机

A类地址占所有IP的一半

##### B类地址

整个B类地址空间共约有230个地址，占整个IP地址空间的25%

- 网络号全0、主机号全0、全1也适用于B类地址

##### C类地址

整个C类地址空间共约有229个地址，占整个IP地址的12.5%。

- 网络号全0,、主机全0、全1也适用于C类地址

上述哪些特殊的IP总结如下

![image-20210110162547962](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110162547962.png)

##### 各类的私有地址

在IP地址3种主要类型里，又各保留了3个区域作为私有地址，也就是比较常用的ip地址。其地址范围如下：
A类地址：10.0.0.0～10.255.255.255
B类地址：172.16.0.0～172.31.255.255
C类地址：192.168.0.0～192.168.255.255

#### 子网的划分

##### 为什么要划分子网

使用分类的IP地址有几个缺点

- IP地址空间利用率低，一个A类地址可容纳主机数超千万，但实际网络因为各种原因远远达不到这个数量，导致利用率低。导致IP地址浪费
- 网络号+主机号的方式不够灵活，要开通新的网络，只能获取一个新的网络号，过程缓慢

##### 子网划分的方式

子网划分就是将两级网络变成三级网络。使得网络号+主机号的方式变成主机号+子网号+主机号的方式。原来的子网号被再次划分了。

为了能够快速得出被划分后的子网号，使用子网掩码。将IP地址与子网掩码做与运算，即可马上得出该IP地址对应的子网号。

![image-20210110174441628](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110174441628.png)

##### 默认子网掩码

在不划分子网时，依旧需要子网掩码，因为子网掩码在现在的网络要求中已经是必须的了，它是一个网络或一个子网的重要属性。

例如，A类地址的子网掩码是255.0.0.0

新标准的路由表包含几个内容：目的网络地址、子网掩码、下一跳地址。与之前相比，多了子网掩码，每次进行网络地址匹配前，都需要使用子网掩码计算真实的子网地址。在不划分子网时依旧强制要求使用子网掩码，也是为了路由器能够使用一致的算法进行路由计算。

##### 子网掩码的缺点

将原本的主机地址部分用于做子网，好处是增加灵活性，坏处就是减少了一个网络地址容纳的主机数量，且子网划分得越多，挤占主机地址越多，能够容纳的主机越少。

#### 无分类域间路由选择，CIDR（构成超网）

##### 为什么要CIDR

- B类地址即将用完
- 因特网主干网上的路由表项目数急剧增长

使用CIDR的一个好处就是可以更加有效地分配IPv4的地址空间，可根据客户的需要分配适当大小的CIDR地址块。

##### 什么是CIDR

- 消除传统的A、B、C类地址和子网划分的概念。只使用网络前缀和主机号。即又从三级变回了两级，只不过没了IP分类。

  记录方法：128.14.35.7/20，表示前20个bit是网络前缀。

- CIDR把网络前缀都相同的连续的IP地址组成一个“CIDR地址块”

##### 地址聚合

地址聚合是相对的，指的是原本需要由多个分类地址表示的网络块，现在只需要一个前缀表示即可。例如，为某单位分配四个C类网络地址，则在路由表中至少需要四条记录（因为分类地址决定了最小分配单位必须为某一类地址），但如果使用前缀，则只需要一条（因为已经没有分类的概念的）

**CIDR的使用已经推迟了IP地址将要耗尽的日期。**

### IP地址与硬件地址

**一定要搞清楚IP地址与硬件地址的区别：一定！！！**

IP地址：网络层使用的IP地址，是逻辑地址，是会发生变化的。

硬件地址：数据链路层和物理层使用的地址，是真实的地址（一块网卡对应的地址，是永远不会变的）。

二者的关系：使用IP地址的IP数据报一旦交给了数据链路层，就被封装成MAC帧了。MAC帧的源地址和目标地址都是硬件地址。MAC帧被传输到目标端时，从MAC帧中解析出IP报文，才能看到源IP地址和目标IP地址

总之，IP 地址放在 IP 数据报的首部，而硬件地址则放在 MAC 帧的首部。在网络层和网络层以上使用的是 IP 地址，而数据链路层及以下使用的是硬件地址。数据链路层看不见数据报的IP地址。如下图

![image-20210110163837903](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110163837903.png)

下图非常形象地展示了IP地址和MAC地址在报文传输时各自扮演的角色

![image-20210110164007703](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110164007703.png)

**强调一点：路由器只根据目的站的IP地址的网络号进行路由选择。**

### 网络层转发分组的流程

#### 路由器转发分组的流程

路由器存储有路由表，即目标主机所在网络和下一跳地址。如

![image-20210110170201182](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110170201182.png)

总结如下

- 从数据报的首部提取目的主机的IP地址D, 得出目的网络地址为N。
- 若N就是与此路由器直接相连的某个网络地址，则进行直接交付；否则执行下一步。
- 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行下一步。
- 若路由表中有到达网络N的路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行下一步。
- 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行下一步
- 报告分组转发错误

#### IP数据报中没有下一跳路由器的IP地址，那么待转发的数据报又怎样能够找到下一跳路由器呢？

答案是ARP，路由器收到报文后，根据路由表得出下一跳IP地址，再由ARP将其转换为下一跳路由器的MAC地址，从而转发过去。前面有说过，ARP存储了IP和MAC地址的对应关系。

#### 路由器的路由表建立过程？



### 路由选择协议

#### 几个概念

- 静态路由选择策略：即手动添加路由表项目，适合小型系统。

- 动态路由选择策略：即根据算法动态调整路由表项目，计算复杂，但适用于随时处于变化中的互联网。

- 分层次的路由选择协议：由于因特网规模非常大，且许多单位不愿意让外界看到自己的网络布局，因此将整个互联网划分为许多小的自治系统，简称AS。每个AS对外部表现的是一个单一的和一致的路由选择策略。

  如一个ISP就可以算作是一个AS。

- IGP：内部网关协议，即在AS内部使用的协议，如RIP和OSPF

- EGP：外部网关协议，AS之间的协议，需要将一个AS使用的路由协议转换为另一个系统使用的路由协议。如BGP-4

- 域间路由选择：即AS之间的路由选择
- 域内路由选择：即AS内部的路由选择

注意：上面说的网关并非严格意义上的网关，这里指的是网络层的的转换，路由器的概念。

#### RIP

即Route Infomation Protocol，它是分布式的基于距离向量的路由选择协议。

距离：即到达目标主机经过的路由次数，每路由一次都增加1。1又称为跳数。RIP允许一条路径的最大跳数为15，因此仅适合小型网络。

特点

- 仅和相邻路由器交换信息
- 路由器交换的信息是当前本路由器所知道的全部信息，即自己的路由表
- 按固定的时间间隔交换路由信息，例如，每隔30秒。然后路由器根据收到的路由信息更新路由表

路由器刚开始工作时，只知道它的相邻路由器，按照相邻交换的方式，最终会进行收敛，得到正确的路由表信息。

优点

- 实现简单，开销小

缺点

- 最长路径跳数规定为15，限制了网络的大小
- 路由器之间交换的是完整路由表，网络扩大后消耗会增加
- “坏消息传播得慢”，使更新过程的收敛时间过长。

#### OSPF

Open Shortest Path First，开放最短路径优先

与RIP相比的特点

- 向本自治系统中所有路由器发送信息。这就是路由器通过所有输出端口向所有相邻的路由器发送信息。而每一个相邻路由器又再将此信息发往其所有的相邻路由器（但不再发送给刚刚发来信息的那个路由器）

  RIP仅向相邻路由器发送数据。

- 发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。所谓 “链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)。OSPF将这个“度量”用来表示费用、距离、时延、带宽，等等。

  RIP发送的到所有路由器的距离。

- 只有当链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息。

  RIP还会定时交换信息。

原理就是这样，但实现起来较为复杂，有兴趣自己去研究。

#### BGP

边界网关协议BGP只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。BGP采用了路径向量(path vector)路由选择协议，它与距离向量协议（如RIP）和链路状态协议（如OSPF）都有很大的区别。

- 核心：BGP发言人，每个AS都要有一个BGP发言人，两个BGP发言人都是通过一个共享网络连接在一起的，而BGP发言人往往就是BGP边界路由器
- BGP发言人交换的路由信息只是：”如果你要访问网络x1、x2...可以经过ASx“，因此它交换路由信息的量级就是AS个数的量级，这比AS内部的网络数少很多

![image-20210110194949987](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110194949987.png)

### 路由器的组成

组成如下，在路由器设计中，怎样提高查找转发表的速率是一个十分重要的研究课题。

![image-20210110195150709](/home/floyd/PersonalCode/notes-gd/notes/%E8%BF%90%E7%BB%B4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/image-20210110195150709.png)



# 不是说IP地址耗尽了吗？为什么我们还能用？

因为NAT

# 阿里云提供的哪些内网IP，为什么总是以172\192之类的开头？



# 《高性能Linux服务构建实战》



# 《Devops入门与实践》



# 《白帽子讲web安全》



# 《Kubernetes微服务实战》



# 《Kubernetes实战》