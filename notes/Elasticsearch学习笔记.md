# 概述

## 几个产品

Apache Lucene是一个开源的分布式包

Apache Solr是基于Lucene的一个开源的分布式搜索引擎：2004年发布

Elasticsearch也是基于Lucene的一个开源的分布式搜索引擎：2010年发布

Apache Lucene和Solr在2010年时已经合并为一个Apache项目

## ES能做什么

### 功能

- 基本的搜索功能
  - 倒排索引
  - 根据词频得到的结果相关性
- 额外功能
  - 处理拼写错误
  - 支持近义词
  - 支持统计信息
  - 可给与自动提示

### 场景

- 直接当后端的数据库，存储和查询都在ES中做
- 只当搜索引擎，存储在数据库中，搜索在ES中，ES中存储数据的索引，有一个数据同步问题。

## ES基本原理

### 核心概念（ES的逻辑设计）

- 文档

  和一般NoSQL数据库中的文档概念一致，用于存储某条记录。一个文档是一个JSON对象，具有层次结构，且层次结构灵活固定（没有预先定义好的schema）

  ES的最小单位是文档，因此更新和搜索的目标都是文档

  文档使用文档ID标识

  文档类比关系数据库中的行。

- 类型

  类型是文档的容器，即用来盛装一系列文档。在逻辑上，一个文档属于一个类型。

  尽管文档本身没有schema限制，但是在同一个类型中最好放入相同schema的文档。

  一定程度上，类型可以理解为相同schema的文档的集合

  类型类比关系数据库中的表格。

  - 子概念——映射

    类型中字段的定义称为映射。例如name字段映射为string

- 索引

  索引是类型的容器，是独立的大量文档的集合。
  
  索引类比关系数据库的database

每篇文章属于一种类型，每种类型属于一个索引。

索引-类型-文档ID唯一确定了ES中的某篇文档。在搜索时，可以查找特定索引、特定类型中的文档。也可以跨多个类型甚至索引进行搜索。

### 如何做到分布式

- 分片

  ES默认分片，每个分片还有一个副本分片用于保证可用性。数据库的复制和扩展都是以分片为最小单位。这和Redis的虚拟槽相似（将所有数据映射到多个槽，在集群节点扩展和减少时只需要迁移槽即可）

  一份分片就是一个Lucene索引

  同一个ES索引中的索引文档，无论何种类型，都存储在相同分片的同一组文件中。因此，**类型的概念仅是ES上的抽象，并不属于Lucene**

  由于类型概念是ES提供的，因此ES是首先从lucene索引中获取符合要求的文档，再自己根据类型过滤一遍。

- 节点

  真实的物理机器。

### 如何索引和搜索

- 索引

  索引一个文档时，通过hash算法决定将文档索引到哪个分片上，在该分片和其副分片都索引完成后，索引命令返回成功。

- 搜索

  通过round-robin轮询的方法，轮询可用的分片，并将搜索请求转发过去，所有分片响应后再集合搜索结果，返回给用户。

## 第三章 索引、更新和删除数据



# 疑问

- ES这类搜索引擎和百度谷歌一类搜索引擎的异同？
- 我们目前系统中的高亮是如何实现的？
- Solr和ES区别？不要完全看网上的对比，他们是带有有色眼镜的，可以参考《Solr实战》
- 什么时候应该使用NoSQL数据库，什么时候应该使用SQL数据库？